---
title: '[docker-swarm] docker swarm ê³ ê¸‰ (2)'
excerpt: "docker-swarm"

categories:
  - docker
tags: 
  - [docker]

date: 2023-01-26
last_modified_at: 2023-01-26
---

# ğŸ¯Docker Swarm ê³ ê¸‰ (2)
- config
- secret

## config ë€?
- **configë¥¼** ì‚¬ìš©í•˜ë©´ ì„œë¹„ìŠ¤ ì´ë¯¸ì§€ ë˜ëŠ” ì‹¤í–‰ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ì™¸ë¶€ì— ì„¤ì • íŒŒì¼ê³¼ ê°™ì€ ë¯¼ê°í•˜ì§€ ì•Šì€ ì •ë³´ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **configëŠ”** ì•”í˜¸í™”ë˜ì§€ ì•Šìœ¼ë©´ì„œ Memoryë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì»¨í…Œì´ë„ˆì˜ íŒŒì¼ì‹œìŠ¤í…œì— ì§ì ‘ ë§ˆìš´íŠ¸ëœë‹¤ëŠ” ì ì„ ì œì™¸í•˜ë©´ secretê³¼ ìœ ì‚¬í•œ ë°©ì‹ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.
- **configëŠ”** ì–¸ì œë“ ì§€ ì„œë¹„ìŠ¤ì—ì„œ ì¶”ê°€í•˜ê±°ë‚˜ ì œê±°í•  ìˆ˜ ìˆìœ¼ë©° ì„œë¹„ìŠ¤ì—ì„œ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **configëŠ”** í™˜ê²½ ë³€ìˆ˜ ë˜ëŠ” ë ˆì´ë¸”ê³¼ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ë‚˜.
- **configëŠ”** ì¼ë°˜ ë¬¸ìì—´ ë˜ëŠ” ì´ì§„ ë°ì´í„°(ìµœëŒ€ 500kb)ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Dockerì—ì„œ configë¥¼ ê´€ë¦¬í•˜ëŠ” ë°©ë²•
- Swarmì— configì„ ì¶”ê°€í•˜ë©´ DockerëŠ” ìƒí˜¸ TLS ì—°ê²°ì„ í†µí•´ configë¥¼ Swarm ê´€ë¦¬ìì—ê²Œ ë³´ëƒ…ë‹ˆë‹¤.
- configëŠ” ì•”í˜¸í™”ëœ Raft ë¡œê·¸ì— ì €ì¥ë˜ê³  ì „ì²´ Raft ë¡œê·¸ëŠ” ë‹¤ë¥¸ ê´€ë¦¬ìì—ê²Œ ë³µì œë˜ì–´ ê³ ê°€ìš©ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.
- ìƒˆë¡œ ë§Œë“¤ê±°ë‚˜ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ì— configì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•˜ë©´ configê°€ ì»¨í…Œì´ë„ˆì— íŒŒì¼ë¡œ ë§ˆìš´íŠ¸ë©ë‹ˆë‹¤.
- ë¦¬ëˆ…ìŠ¤ ì»¨í…Œì´ë„ˆì—ì„œ configëŠ” ê¸°ë³¸ì ìœ¼ë¡œ  `/<config-name>`ì— ë§ˆìš´íŠ¸ë©ë‹ˆë‹¤.
- ìœˆë„ìš° ì»¨í…Œì´ë„ˆì—ì„œ configëŠ” ê¸°ë³¸ì ìœ¼ë¡œ `C:\ProgramData/Docker\configs`ì— ëª¨ë‘ ë§ˆìš´íŠ¸ë˜ê³  `C:\<config-name>`ê³¼ ê°™ì´ ì›í•˜ëŠ” ìœ„ì¹˜ì— ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
- configëŠ” ì†Œìœ ê¶Œê³¼ ê¶Œí•œì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ì„¤ì •ì€ windows ì»¨í…Œì´ë„ˆì—ì„œëŠ” ë¬´ì‹œë©ë‹ˆë‹¤.
  - ì†Œìœ ê¶Œì„ ì„¤ì •í•˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•œ userì™€ userì˜ ê¸°ë³¸ ê·¸ë£¹ì´ ì„¤ì •ë©ë‹ˆë‹¤.
  - ê¶Œí•œì„ ì„¤ì •í•˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ (`0444`) ê¶Œí•œì„ ê°€ì§€ë©°, ì´ë–„ `umask` ê°’ì˜ ì˜í–¥ì„ ë°›ìŠµë‹ˆë‹¤.
- ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ë¥¼ í†µí•´ configì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ë…¸ë“œëŠ” Swarm ê´€ë¦¬ì ë…¸ë“œì´ê±°ë‚˜ configì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ë¶€ì—¬ëœ ì„œë¹„ìŠ¤ taskë¥¼ ì‹¤í–‰ ì¤‘ì¸ ë…¸ë“œì—ì„œë§Œ configì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš© ì¤‘ì¸ configëŠ” ì œê±°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ë‹¨í•˜ì§€ ì•Šê³  configì„ ì œê±°í•˜ëŠ” ë°©ë²•ì€ [config êµì²´](#config-êµì²´)ì„ ì°¸ê³ í•˜ì„¸ìš”.
- configì„ ë³´ë‹¤ ì‰½ê²Œ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ë¡¤ë°±í•˜ë ¤ë©´ config ì´ë¦„ì— ë²„ì „ ë²ˆí˜¸ë‚˜ ë‚ ì§œë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

### docker config ëª…ë ¹
```bash
# TODO 1. Dockerì— configì„ ì¶”ê°€í•©ë‹ˆë‹¤. 
$ echo "This is a config" | docker config create my-config -

# docker config create ëª…ë ¹ì—ì„œ configë¥¼ ì½ì„ íŒŒì¼ì„ ë‚˜íƒ€ë‚´ëŠ” ë§ˆì§€ë§‰ ì¸ìˆ˜ë¡œ '-'ê°€ ì“°ì˜€ê¸° ë•Œë¬¸ì—  í‘œì¤€ ì…ë ¥ì„ ì½ìŠµë‹ˆë‹¤.

# TODO 2. redis ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ê³  configì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
$ docker service create --name redis \
--config my-config \
redis:alpine

# ê¸°ë³¸ì ìœ¼ë¡œ ì»¨í…Œì´ë„ˆëŠ” '/my-config'ì—ì„œ config ë¥¼ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆì§€ë§Œ 'target' ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ì´ë¦„ì„ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

# TODO 3. docker service psë¥¼ ì‚¬ìš©í•˜ì—¬ taskë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
$ docker service ps redis

ID            NAME     IMAGE         NODE              DESIRED STATE  CURRENT STATE          ERROR  PORTS
bkna6bpn8r1a  redis.1  redis:alpine  ip-172-31-46-109  Running        Running 8 seconds ago

# TODO 4.1 docker psë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ task ì»¨í…Œì´ë„ˆì˜ IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
$ docker ps --filter name=redis -q

5cb1c2348a59

# TODO 4.2 docker execë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆì— ì—°ê²°í•˜ê³  config íŒŒì¼ì„ í™•ì¸í•©ë‹ˆë‹¤.
$ docker container exec $(docker ps --filter name=redis -q) ls -l /my-config

-r--r--r--    1 root     root            12 Jun  5 20:49 my-config

# TODO 4.3 docker execë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆì— ì—°ê²°í•˜ê³  config íŒŒì¼ì˜ ë‚´ìš©ì„ í™•ì¸í•©ë‹ˆë‹¤.
$ docker container exec $(docker ps --filter name=redis -q) cat /my-config

This is a config

# config íŒŒì¼ì€ ê¸°ë³¸ì ìœ¼ë¡œ 0444 ê¶Œí•œì„ ê°–ê¸° ë•Œë¬¸ì— ëª¨ë“  ì‚¬ìš©ìê°€ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

# TODO 5. configë¥¼ ì œê±°í•©ë‹ˆë‹¤.
$ docker config ls

ID                          NAME                CREATED             UPDATED
fzwcfuqjkvo5foqu7ts7ls578   hello               31 minutes ago      31 minutes ago

$ docker config rm my-config

Error response from daemon: rpc error: code = 3 desc = config 'my-config' is
in use by the following service: redis

# redis ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì´ê³  configì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ìˆê¸° ë•Œë¬¸ì— ì‚­ì œì— ì‹¤íŒ¨í•©ë‹ˆë‹¤.

# TODO 6. redis ì„œë¹„ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ì—ì„œ configì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
$ docker service update --config-rm my-config redis

# TODO 7. ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€ ë° ì œê±°í•˜ê³  Dockerì—ì„œ configë¥¼ ì œê±°í•©ë‹ë‚˜.
$ docker service rm redis
$ docker config rm my-config
```

### config êµì²´
```bash
# TODO 1. index.html íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
$ echo "helloworld-v1" > index.html

# TODO 2. index.html íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ index.html-v1 configë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
$ docker config create index.html-v1 index.html

# TODO 3. index.html-v1 configì„ ì‚¬ìš©í•˜ì—¬ Nginx ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
$ docker service create --name my-nginx \
--replicas 3 \
--config src=index.html-v1,target=/usr/share/nginx/html/index.html \
--publish published=80,target=80
nginx:latest

# TODO 4. curlì„ ì‚¬ìš©í•˜ì—¬ configê°€ ì˜ ë°˜ì˜ëëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
$ curl localhost
helloworld-v1

# TODO 5. index.html íŒŒì¼ì„ ìˆ˜ì •í•©ë‹ˆë‹¤.
$ echo "helloworld-v2" > index.html

# TODO 6. ìˆ˜ì •ëœ index.html íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ index.html-v2 configì„ ìƒì„±í•©ë‹ˆë‹¤.
$ docker config create index.html-v2 index.html

# TODO 7. ì´ì „ config ëŒ€ì‹  ìƒˆë¡œìš´ configë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„œë¹„ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
$ docker service update \
--config-rm index.html-v1 \
--config-add source=index.html-v2,target=/usr/share/nginx/html/index.html \
my-nginx

# TODO 8. ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ê³  configê°€ ìˆ˜ì •ëëŠ”ì§€ curlì„ í†µí•´ í™•ì¸í•©ë‹ˆë‹¤.
$ curl localhost
helloworld-v2

# TODO 9. ê¸°ì¡´ configë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.
$ docker config rm index.html-v1
```

## secret ë€?
- **secretì€** ì•”í˜¸, SSH ê°œì¸ í‚¤, SSL ì¸ì¦ì„œ ë“± ë¯¼ê°í•œ ì •ë³´ë¥¼ ì•¡ì„¸ìŠ¤ê°€ í•„ìš”í•œ ì»¨í…Œì´ë„ˆì—ë§Œ ì•ˆì „í•˜ê²Œ ì „ì†¡í•  ìˆ˜ ìˆë‹¤.
- **secretì€** Docker Swarmì—ì„œ ìœ íœ´ ìƒíƒœ ë° ì „ì†¡ ì‹œì— ì•”í˜¸í™”ë©ë‹ˆë‹¤.
- **secretì€** ëª…ì‹œì  ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ë¶€ì—¬ëœ ì„œë¹„ìŠ¤ì—ì„œ í•´ë‹¹ ì„œë¹„ìŠ¤ taskê°€ ì‹¤í–‰ë˜ëŠ” ë™ì•ˆì—ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **secretì„** ì‚¬ìš©í•˜ì—¬ ì„¤ì • íŒŒì¼ê³¼ ê°™ì€ ë¯¼ê°í•˜ì§€ ì•Šì€ ë°ì´í„°ë¥¼ ê´€ë¦¬í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ DockerëŠ” ì´ëŸ¬í•œ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ configë¥¼ ì§€ì›í•©ë‹ˆë‹¤.

### Dockerì—ì„œ secretì„ ê´€ë¦¬í•˜ëŠ” ë°©ë²•
- Swarmì— secretì„ ì¶”ê°€í•˜ë©´ DockerëŠ” ìƒí˜¸ TLS ì—°ê²°ì„ í†µí•´ Swarm ê´€ë¦¬ìì—ê²Œ secretì„ ë³´ëƒ…ë‹ˆë‹¤.
- secretì€ Raft ë¡œê·¸ì— ì €ì¥ë˜ê³  ì „ì²´ Raft ë¡œê·¸ëŠ” ë‹¤ë¥¸ ê´€ë¦¬ìì—ê²Œ ë³µì œë˜ì–´ ê³ ê°€ìš©ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.
- ìƒˆë¡œ ìƒì„±ë˜ê±°ë‚˜ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ì— secretì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•˜ë©´ ë³µí˜¸í™”ëœ secretì´ ì»¨í…Œì´ë„ˆì˜ ì¸ë©”ëª¨ë¦¬ íŒŒì¼ì‹œìŠ¤í…œ ë‚´ì— ë§ˆìš´íŠ¸ë©ë‹ˆë‹¤.
- ë¦¬ëˆ…ìŠ¤ ì»¨í…Œì´ë„ˆì—ì„œ ë§ˆìš´íŠ¸ ìœ„ì¹˜ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ `/run/secrets/<secret_name>` ì…ë‹ˆë‹¤.
- ìœˆë„ìš° ì»¨í…Œì´ë„ˆì—ì„œ ë§ˆìš´íŠ¸ ìœ„ì¹˜ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ `C:\ProgramData\Docker\secrets` ì…ë‹ˆë‹¤.
- ë§ˆìš´íŠ¸ ìœ„ì¹˜ëŠ” ì‚¬ìš©ìê°€ ì§€ì •í•œ ìœ„ì¹˜ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ì–¸ì œë“ ì§€ secretì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•˜ê±°ë‚˜ ì·¨ì†Œí•˜ë„ë¡ ì„œë¹„ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ë…¸ë“œëŠ” ë…¸ë“œê°€ Swarm ê´€ë¦¬ìì´ê±°ë‚˜ secretì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ë¶€ì—¬ëœ ì„œë¹„ìŠ¤ taskê°€ ì‹¤í–‰ ì¤‘ì¸ ë…¸ë“œì—ì„œë§Œ secretì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- task ì‹¤í–‰ì´ ì¤‘ì§€ë˜ë©´ í•´ë‹¹ taskì— ê³µìœ ëœ secretì´ í•´ë‹¹ ì»¨í…Œì´ë„ˆì˜ ì¸ë©”ëª¨ë¦¬ íŒŒì¼ì‹œìŠ¤í…œì—ì„œ ë§ˆìš´íŠ¸ í•´ì œë˜ê³  ë…¸ë“œì˜ ë©”ëª¨ë¦¬ì—ì„œ í”ŒëŸ¬ì‹œë©ë‹ˆë‹¤.
- ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš© ì¤‘ì¸ secretì€ ì œê±°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ë‹¨í•˜ì§€ ì•Šê³  secretì„ ì œê±°í•˜ëŠ” ë°©ë²•ì€ [ì•”í˜¸ êµì²´](#ì•”í˜¸-êµì²´)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.
- secretì„ ë³´ë‹¤ ì‰½ê²Œ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ë¡¤ë°±í•˜ë ¤ë©´ secret ì´ë¦„ì— ë²„ì „ ë²ˆí˜¸ ë˜ëŠ” ë‚ ì§œë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

### docker secret ëª…ë ¹
```bash
# TODO 1. Dockerì— secretì„ ì¶”ê°€í•©ë‹ˆë‹¤. 
$ echo "This is a secret" | docker secret create my_secret -

# ì½ì„ íŒŒì¼ì„ ë‚˜íƒ€ë‚´ëŠ” docker secret create ëª…ë ¹ì˜ ë§ˆì§€ë§‰ ì¸ìˆ˜ê°€ '-'ë¡œ ì„¤ì •ë˜ì—ˆê¸° ë•Œë¬¸ì— ì´ ëª…ë ¹ì€ í‘œì¤€ ì…ë ¥ìœ¼ë¡œë¶€í„° ì½ìŠµë‹ˆë‹¤.

# TODO 2. redis ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ê³  secretì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
$ docker service create --name redis \
--secret my_secret \
redis:alpine

# ê¸°ë³¸ì ìœ¼ë¡œ ì»¨í…Œì´ë„ˆëŠ” /run/secrets/<secret_name> ì—ì„œ secretì— ì•¡ìƒˆìŠ¤í•  ìˆ˜ ìˆì§€ë§Œ 'target' ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ì´ë¦„ì„ ì‚¬ìš©ì ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

# TODO 3. docker service ps ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ taskê°€ ë¬¸ì œ ì—†ì´ ì‹¤í–‰ë˜ê³  ìˆëŠ” ì§€ í™•ì¸í•©ë‹ˆë‹¤.
$ docker service ps redis
ID             NAME      IMAGE          NODE        DESIRED STATE   CURRENT STATE            ERROR     PORTS
oof8fjabuodd   redis.1   redis:alpine   manager02   Running         Running 13 seconds ago

# TODO 4.1 docker ps ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ task ì»¨í…Œì´ë„ˆì˜ IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
$ docker ps --fliter name=redis -q
f593f75ddc4e

# TODO 4.2 docker container exec ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆì— ì—°ê²°í•˜ê³  secret íŒŒì¼ì„ ì½ìŠµë‹ˆë‹¤.
$ docker container exec $(docker ps --filter name=redis -q) ls -l /run/secrets/my_secret
-r--r--r--    1 root     root            15 Jan 27 12:43 /run/secrets/my_secret

$ docker container exec $(docker ps --filter name=redis -q) cat /run/secrets/my_secret
This is secret

# ê¸°ë³¸ì ìœ¼ë¡œ ì»¨í…Œì´ë„ˆì˜ ì¸ëª¨ë©”ë¦¬ íŒŒì¼ì‹œìŠ¤í…œì— ë§ˆìš´íŠ¸ëœ secretì˜ íŒŒì¼ ì´ë¦„ì€ secret ì´ë¦„ê³¼ ê°™ê³  ëª¨ë“  ì‚¬ëŒì´ ì½ì„ ìˆ˜ ìˆëŠ” ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤.

# TODO 5. secretì„ ì œê±°í•©ë‹ˆë‹¤.
$ docker secret ls
ID                          NAME        DRIVER    CREATED          UPDATED
p8r88mgp0a7y0krmw2f6y75ab   my_secret             11 minutes ago   11 minutes ago

$ docker secret rm my_secret
Error response from daemon: rpc error: code = InvalidArgument desc = secret 'my_secret' is in use by the following service: redis

# redis ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì´ê³  secretì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì œê±°ì— ì‹¤íŒ¨í•©ë‹ˆë‹¤.

# TODO 6. redis ì„œë¹„ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ì—ì„œ secretì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
$ docker service update --secret-rm my_secret redis

# TODO 7. ì¬ë°°í¬ëœ ì„œë¹„ìŠ¤ì—ì„œ secretì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
$ docker container exec $(docker ps --filter name=redis -q) ls -l /run/secrets/my_secret
ls: /run/secrets/my_secret: No such file or directory

# TODO 8. ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€ ë° ì œê±°í•˜ê³  Dockerì—ì„œ secretì„ ì œê±°í•©ë‹ˆë‹¤.
$ docker service rm redis
$ docker secret rm my_secret
```

### ì•”í˜¸ êµì²´
```bash
# TODO 1. MySQLì— ëŒ€í•œ ì„ì˜ì˜ ì˜ë¬¸ìì™€ ìˆ«ìë¡œ ì¡°í•©ëœ secretì„ ìƒì„±í•©ë‹ˆë‹¤.
$ openssl rand -base64 20 | docker secret create mysql_password -
ln3k4tpp5l9c60oezq0zwsinr

$ openssl rand -base64 20 | docker secret create mysql_root_password -
xal6giwy2wluo5cxohxnbpssl

$ docker secret ls
D                          NAME                  DRIVER    CREATED          UPDATED
ln3k4tpp5l9c60oezq0zwsinr   mysql_password                  39 seconds ago   39 seconds ago
xal6giwy2wluo5cxohxnbpssl   mysql_root_password             25 seconds ago   25 seconds ago

# TODO 2. mysql ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
$ docker service create \
--name mysql \
--replicas 1 \
--mount type=volume,source=mydata,destination=/var/lib/mysql \
--secret source=mysql_root_password,target=mysql_root_password \
--secret source=mysql_password,target=mysql_password \
-e MYSQL_ROOT_PASSWORD_FILE="/run/secrets/mysql_root_password" \
-e MYSQL_PASSWORD_FILE="/run/secrets/mysql_password" \
-e MYSQL_USER="admin"
-e MYSQL_DATABASE="test" \
mysql:latest

# TODO 3. ìƒˆ secretì„ ìƒì„±í•˜ê³  ì´ë¦„ì€ mysql_password_v2ë¡œ í•©ë‹ˆë‹¤.(í•´ë‹¹ ì˜ˆì œì—ì„œëŠ” mysql_root_passwordëŠ” ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)
$ openssl rand -base64 20 | docker secret create mysql_password_v2 -

# TODO 4. ì´ì „ secretê³¼ ìƒˆë¡œ ìƒì„±í•œ secretì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ëª¨ë‘ ë¶€ì—¬í•˜ë„ë¡ mysql ì„œë¹„ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
$ docker service update \
--secret-rm mysql_password \
mysql

$ docker service update \
--secret-add source=mysql_password,target=old_mysql_password
--secret-add source=mysql_password_v2,target=mysql_password \
mysql

# TODO 5. MySQL ì„œë¹„ìŠ¤ì—ì„œ ì´ì „ secretì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ì·¨ì†Œí•˜ê³  Dockerì—ì„œ ì´ì „ secretì„ ì œê±°í•©ë‹ˆë‹¤.
$ docker service update \
--secret-rm mysql_password \
mysql

$ docker secret rm mysql_password
```

### ì´ë¯¸ì§€ ë¹Œë“œì—ì„œ secret ì§€ì›
- ë¯¼ê°í•œ ë°ì´í„°ê°€ í™˜ê²½ ë³€ìˆ˜ë¡œ í•„ìš”í•œ ì»¨í…Œì´ë„ˆë¥¼ ê°œë°œí•˜ëŠ” ê²½ìš° secretì„ í™œìš©í•˜ë„ë¡ ì´ë¯¸ì§€ë¥¼ ì¡°ì •í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
- ì´ë¥¼ ìˆ˜í–‰í•˜ëŠ” í•œ ê°€ì§€ ë°©ë²•ì€ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•  ë•Œ í™˜ê²½ ë³€ìˆ˜ë¥¼ íŒŒì¼ì—ì„œë„ ì½ì„ ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
- ì˜ˆë¥¼ ë“¤ì–´, WordPress ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘í•  ë•Œ í•„ìš”í•œ í™˜ê²½ ë³€ìˆ˜ì¸ `WORDPRESS_DB_PASSWORD`ëŠ” íŒŒì¼ì—ì„œë„ í•´ë‹¹ ê°’ì„ ì½ì„ ìˆ˜ ìˆë„ë¡ `WORDPRESS_DB_PASSWORD_FILE` í™˜ê²½ ë³€ìˆ˜ê°€ í¬í•¨ë˜ë„ë¡ ì´ë¯¸ì§€ê°€ ì—…ë°ì´íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤.

### docker-composeì—ì„œ secret ì‚¬ìš©
```yml
version: "3.9"

services:
   db:
     image: mysql:latest
     volumes:
       - db_data:/var/lib/mysql
     environment:
       MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
       MYSQL_DATABASE: wordpress
       MYSQL_USER: wordpress
       MYSQL_PASSWORD_FILE: /run/secrets/db_password
     secrets:
       - db_root_password
       - db_password

   wordpress:
     depends_on:
       - db
     image: wordpress:latest
     ports:
       - "8000:80"
     environment:
       WORDPRESS_DB_HOST: db:3306
       WORDPRESS_DB_USER: wordpress
       WORDPRESS_DB_PASSWORD_FILE: /run/secrets/db_password
     secrets:
       - db_password


secrets:
   db_password:
     file: db_password.txt
   db_root_password:
     file: db_root_password.txt

volumes:
    db_data:
```

## ğŸ“Œì¶œì²˜
[Docker Docs](https://docs.docker.com/engine/swarm/swarm-tutorial/drain-node/)

***
    ğŸ‘ ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ì˜¤ë¥˜ë‚˜ ì¡°ì–¸ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ëŒ“ê¸€ í˜¹ì€ ë©”ì¼ë¡œ ë‚¨ê²¨ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤! ğŸ˜„

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}