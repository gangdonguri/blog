---
title: '[docker-swarm] docker swarm ì‹œì‘í•˜ê¸° (2)'
excerpt: "docker-swarm"

categories:
  - docker
tags: 
  - [docker]

date: 2023-01-17
last_modified_at: 2023-01-17
---

# ğŸ¯ëª©ì°¨
- ì„œë¹„ìŠ¤ì— ë¡¤ë§ ì—…ë°ì´íŠ¸ ì ìš©
- ë…¸ë“œ Drain
- Swarm Mode ë¼ìš°íŒ… ë©”ì‹œ ì‚¬ìš©

## ì„œë¹„ìŠ¤ì— ë¡¤ë§ ì—…ë°ì´íŠ¸ ì ìš©
### ì‹œë‚˜ë¦¬ì˜¤
Redis 3.0.6 ì»¨í…Œì´ë„ˆë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„œë¹„ìŠ¤ë¥¼ ë°°í¬í•œ í›„ ë¡¤ë§ ì—…ë°ì´íŠ¸ë¥¼ í†µí•´ Redis 3.0.7 ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„œë¹„ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸ í•©ë‹ˆë‹¤.

```bash
# TODO 1. ê´€ë¦¬ì ë…¸ë“œì—ì„œ Redis 3.0.6 íƒœê·¸ë¥¼ ê°€ì§„ ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. 
docker service create \
  --replicas 3 \
  --name redis \
  --update-delay 10s \
  redis:3.0.6

0u6a4s31ybk7yw2wyvtikmu50

: << "END"
'--update-delay': ì„œë¹„ìŠ¤ taskì— ëŒ€í•œ ì—…ë°ì´íŠ¸ ì‚¬ì´ì˜ ì‹œê°„ ê°„ê²©ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. Th, Tm, Ts ë¡œ í‘œê¸°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
'--update-parallelism': ê¸°ë³¸ì ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” í•œ ë²ˆì— í•˜ë‚˜ì˜ taskë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. í•´ë‹¹ í”Œë˜ê·¸ë¥¼ ì‚¬ìš©í•˜ë©´ ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ìµœëŒ€ë¡œ ë™ì‹œì— ì—…ë°ì´íŠ¸í•˜ëŠ”
 task ìˆ˜ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
'--update-failure-action;': ê¸°ë³¸ì ìœ¼ë¡œ ê°œë³„ taskì— ëŒ€í•œ ì—…ë°ì´íŠ¸ ìƒíƒœê°€ 'RUNNING'ì„ ë°˜í™˜í•˜ëŠ” ê²½ìš° ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” 
ì—…ë°ì´íŠ¸í•  ë‹¤ë¥¸ taskë¥¼ ì˜ˆì•½í•©ë‹ˆë‹¤.
 ë°˜ë©´ 'FALIED' ìƒíƒœë¥¼ ë°˜í™˜í•˜ëŠ” ê²½ìš° ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” ì—…ë°ì´íŠ¸ë¥¼ ì¼ì‹œ ì¤‘ì§€í•©ë‹ˆë‹¤. ì´ë•Œ í•´ë‹¹ í”Œë˜ê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ 'FAILED' ì‹œ ë™ì‘ ë°©ì‹ì„ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ìœ„ ì„¸ ê°œì˜ í”Œë˜ê·¸ëŠ” 'docker service create', 'docker service update' ëª…ë ¹ ìˆ˜í–‰ ì‹œ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
END


# TODO 2. ê´€ë¦¬ì ë…¸ë“œì—ì„œ Redis ì„œë¹„ìŠ¤ë¥¼ ê²€ì‚¬í•©ë‹ˆë‹¤.
docker service inspect --pretty redis

ID:             0u6a4s31ybk7yw2wyvtikmu50
Name:           redis
Service Mode:   Replicated
 Replicas:      3
Placement:
 Strategy:	    Spread
UpdateConfig:
 Parallelism:   1
 Delay:         10s
ContainerSpec:
 Image:         redis:3.0.6
Resources:
Endpoint Mode:  vip

# TODO 3. ê´€ë¦¬ì ë…¸ë“œì—ì„œ Swarm ê´€ë¦¬ìëŠ” UpdateConfig ì •ì±…ì— ë”°ë¼ redis ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ì—…ë°ì´íŠ¸ í•©ë‹ˆë‹¤.
 docker service update --image redis:3.0.7 redis
redis

: << "END"
ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë‹¤ìŒì˜ ì ˆì°¨ì— ë”°ë¼ ë¡¤ë§ ì—…ë°ì´íŠ¸ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
1. ì²« ë²ˆì§¸ task ì¤‘ì§€
2. ì¤‘ì§€ëœ taskì— ëŒ€í•œ ì—…ë°ì´íŠ¸ë¥¼ ì˜ˆì•½
3. ì—…ë°ì´íŠ¸ëœ taskì— ëŒ€í•œ ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
4. task ì—…ë°ì´íŠ¸ê°€ RUNNING ìƒíƒœë¥¼ ë°˜í™˜í•˜ë©´ ì§€ì •ëœ ì§€ì—° ì‹œê°„ ë™ì•ˆ ê¸°ë‹¤ë¦° í›„ ë‹¤ìŒ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤.
5. ì—…ë°ì´íŠ¸ ì¤‘ FAILED ìƒíƒœë¥¼ ë°˜í™˜í•˜ë©´ ì—…ë°ì´íŠ¸ë¥¼ ì¼ì‹œ ì¤‘ì§€í•©ë‹ˆë‹¤.
END

# TDOO 4. ê´€ë¦¬ì ë…¸ë“œì—ì„œ 'docker service inpsect --pretty redis' ëª…ë ¹ì„ í†µí•´ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
docker service inspect --pretty redis

ID:             0u6a4s31ybk7yw2wyvtikmu50
Name:           redis
Service Mode:   Replicated
 Replicas:      3
Placement:
 Strategy:	    Spread
UpdateConfig:
 Parallelism:   1
 Delay:         10s
ContainerSpec:
 Image:         redis:3.0.7
Resources:
Endpoint Mode:  vip

: << "END"
- ì—…ë°ì´íŠ¸ê°€ ì‹¤íŒ¨í•œ ê²½ìš° `docker service inspect --pretty redis` ëª…ë ¹ì˜ ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
docker service inspect --pretty redis

ID:             0u6a4s31ybk7yw2wyvtikmu50
Name:           redis
...snip...
Update status:
 State:      paused
 Started:    11 seconds ago
 Message:    update paused due to failure or early termination of task 9p7ith557h8ndf0ui9s0q951b
...snip...

- ì¼ì‹œ ì¤‘ì§€ëœ ì—…ë°ì´íŠ¸ ì‹¤í–‰ì„ ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´ `docker service update <SERVICE-ID>` ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
docker service update redis
END

# TODO 5. ë¡¤ë§ ì—…ë°ì´íŠ¸ë¥¼ ë³´ë ¤ë©´ 'docker service ps <SERVICE-ID>ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
docker service ps redis

NAME                                   IMAGE        NODE       DESIRED STATE  CURRENT STATE            ERROR
redis.1.dos1zffgeofhagnve8w864fco      redis:3.0.7  worker1    Running        Running 37 seconds
 \_ redis.1.88rdo6pa52ki8oqx6dogf04fh  redis:3.0.6  worker2    Shutdown       Shutdown 56 seconds ago
redis.2.9l3i4j85517skba5o7tn5m8g0      redis:3.0.7  worker2    Running        Running About a minute
 \_ redis.2.66k185wilg8ele7ntu8f6nj6i  redis:3.0.6  worker1    Shutdown       Shutdown 2 minutes ago
redis.3.egiuiqpzrdbxks3wxgn8qib1g      redis:3.0.7  worker1    Running        Running 48 seconds
 \_ redis.3.ctzktfddb2tepkr45qcmqln04  redis:3.0.6  mmanager1  Shutdown       Shutdown 2 minutes ago
``` 

## ìŠ¤ì›œì—ì„œ ë…¸ë“œ Drain
### Drain?
- AVAILABILITYê°€ `Drain` ìœ¼ë¡œ ì„¤ì •ëœ ê²½ìš° Swarm ê´€ë¦¬ìë¡œë¶€í„° ìƒˆ taskë¥¼ í• ë‹¹ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤.
- ë˜í•œ ê´€ë¦¬ìëŠ” `Drain` ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ taskë¥¼ ì¤‘ì§€ì‹œí‚¤ê³  ë³µì œë³¸ì„ ACTIVE AVAILABILITY ì¸ ë…¸ë“œì— ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
# TODO 1. ê´€ë¦¬ì ë…¸ë“œì—ì„œ ëª¨ë“  ë…¸ë“œê°€ í™œì„± ìƒíƒœì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.
docker node ls

ID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS
1bcef6utixb0l0ca7gxuivsj0    worker2   Ready   Active
38ciaotwjuritcdtn9npbnkuz    worker1   Ready   Active
e216jshn25ckzbvmwlnh5jr3g *  manager1  Ready   Active        Leader

# TODO 2. redis:3.0.6 ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
docker service create --replicas 3 --name redis --update-delay 10s redis:3.0.6

c5uo6kdmzpon37mgj9mwglcfw

# TODO 3. 'docker service ps redis' ëª…ë ¹ì„ í†µí•´ Swarm ê´€ë¦¬ìê°€ ë‹¤ë¥¸ ë…¸ë“œì— ì‘ì—…ì„ í• ë‹¹í•œ ë°©ë²•ì„ í™•ì¸í•©ë‹ˆë‹¤.
docker service ps redis

NAME                               IMAGE        NODE     DESIRED STATE  CURRENT STATE
redis.1.7q92v0nr1hcgts2amcjyqg3pq  redis:3.0.6  manager1 Running        Running 26 seconds
redis.2.7h2l8h3q3wqy5f66hlv9ddmi6  redis:3.0.6  worker1  Running        Running 26 seconds
redis.3.9bg7cezvedmkgg6c8yzvbhwsd  redis:3.0.6  worker2  Running        Running 26 seconds

# ì´ ê²½ìš° Swarm ê´€ë¦¬ìëŠ” ê° ë…¸ë“œì— í•˜ë‚˜ì˜ ì‘ì—…ì„ ë°°í¬í–ˆìŠµë‹ˆë‹¤. 

# TODO 4. 'docker node update --availability drain <NODE-ID>' ëª…ë ¹ì„ í†µí•´ ë…¸ë“œë¥¼ Drain í•©ë‹ˆë‹¤.
docker node update --availability drain worker1

worker1

# TODO 5. ë…¸ë“œì˜ ê°€ìš©ì„±ì„ í™•ì¸í•©ë‹ˆë‹¤.
docker node inspect --pretty worker1

ID:			38ciaotwjuritcdtn9npbnkuz
Hostname:		worker1
Status:
 State:			Ready
 Availability:		Drain
...snip...

# Availability: Drain ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.

# TODO 6. 'docker service ps redis' ëª…ë ¹ì„ í†µí•´ Swarm ê´€ë¦¬ìê°€ redis ì„œë¹„ìŠ¤ì˜ taskë¥¼ ì–´ë–»ê²Œ í• ë‹¹í–ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
docker service ps redis

NAME                                    IMAGE        NODE      DESIRED STATE  CURRENT STATE           ERROR
redis.1.7q92v0nr1hcgts2amcjyqg3pq       redis:3.0.6  manager1  Running        Running 4 minutes
redis.2.b4hovzed7id8irg1to42egue8       redis:3.0.6  worker2   Running        Running About a minute
 \_ redis.2.7h2l8h3q3wqy5f66hlv9ddmi6   redis:3.0.6  worker1   Shutdown       Shutdown 2 minutes ago
redis.3.9bg7cezvedmkgg6c8yzvbhwsd       redis:3.0.6  worker2   Running        Running 4 minutes

# Swarm ê´€ë¦¬ìëŠ” Drainëœ ë…¸ë“œì—ì„œ taskë¥¼ ì¢…ë£Œí•˜ê³  ACTIVE ìƒíƒœì˜ ë…¸ë“œì— ìƒˆ taskë¥¼ ìƒì„±í•˜ì—¬ ì›í•˜ëŠ” ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.

# TODO 7. 'docker node update --availability active <NODE-ID>' ëª…ë ¹ì„ í†µí•´ Drainëœ ë…¸ë“œë¥¼ ACTIVE ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
docker node update --availability active worker1

worker1

# TODO 8. ë…¸ë“œë¥¼ ê²€ì‚¬í•˜ì—¬ ì—…ë°ì´íŠ¸ëœ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
docker node inspect --pretty worker1

ID:			38ciaotwjuritcdtn9npbnkuz
Hostname:		worker1
Status:
 State:			Ready
 Availability:		Active
...snip...

# ë…¸ë“œë¥¼ ë‹¤ì‹œ ACTIVE ìƒíƒœë¡œ ì„¤ì •í•˜ë©´ ìƒˆ taskë¥¼ í• ë‹¹ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ Drain ìƒíƒœë¡œ ì„¤ì •ë˜ë©´ì„œ ì¤‘ì§€ëœ taskê°€ ë‹¤ì‹œ ì‹¤í–‰ë˜ì§„ ì•ŠìŠµë‹ˆë‹¤. (Rebalancing X)
```

## ìŠ¤ì›œì—ì„œ ë¼ìš°íŒ… ë©”ì‹œ ì‚¬ìš©
- ë¼ìš°íŒ… ë©”ì‹œë¥¼ ì‚¬ìš©í•˜ë©´ Swarmì˜ ê° ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ taskê°€ ì—†ë”ë¼ë„ Swarmì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  ì„œë¹„ìŠ¤ì— ëŒ€í•´ ê²Œì‹œëœ í¬íŠ¸ì˜ ì—°ê²°ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ë‚˜. 
- ë¼ìš°íŒ… ë©”ì‹œëŠ” ì‚¬ìš© ê°€ëŠ¥í•œ ë…¸ë“œì˜ ê²Œì‹œëœ í¬íŠ¸ë¡œ ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  ìš”ì²­ì„ í™œì„± taskë¡œ ë¼ìš°íŒ…í•©ë‹ˆë‹¤.
- Swarmì—ì„œ ì¸ê·¸ë ˆìŠ¤ ë„¤íŠ¸ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ Swarm ëª¨ë“œë¥¼ í™œì„±í™”í•˜ê¸° ì „ì— Swarm ë…¸ë“œ ê°„ì— ë‹¤ìŒ í¬íŠ¸ë¥¼ ì—´ì–´ì•¼ í•©ë‹ˆë‹¤.
  - ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ ê²€ìƒ‰ì„ ìœ„í•œ í¬íŠ¸: `TCP/UDP 7946`
  - ì»¨í…Œì´ë„ˆ ì¸ê·¸ë ˆìŠ¤ ë„¤íŠ¸ì›Œí¬ìš© í¬íŠ¸ : `UDP 4789`
- íŠ¹ì • ì„œë¹„ìŠ¤ì— ëŒ€í•œ ë¼ìš°íŒ… ë©”ì‹œë¥¼ ìš°íšŒí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

### ì„œë¹„ìŠ¤ìš© í¬íŠ¸ ê²Œì‹œ
---
`--publish` í”Œë˜ê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•  ë•Œ í¬íŠ¸ë¥¼ ê²Œì‹œí•©ë‹ˆë‹¤. `target`ì€ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ í¬íŠ¸ë¥¼ ì§€ì •í•˜ê³  `published`ëŠ” ë¼ìš°íŒ… ë©”ì‹œì— ë°”ì¸ë”©í•  í¬íŠ¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
  
```bash
docker service create \
  --name <SERVICE-NAME> \
  --publish published=<PUBLISHED-PORT>,target=<CONTAINER-PORT> \
  <IMAGE>
```
  
- `<PUBLISHED-PORT>`: SWARMì´ ì œê³µí•˜ëŠ” í¬íŠ¸ì…ë‹ˆë‹¤. ìƒëµí•˜ë©´ ì„ì˜ì˜ ë†’ì€ ë²ˆí˜¸ì˜ í¬íŠ¸ê°€ ë°”ì¸ë”©ë©ë‹ˆë‹¤.
- `<CONTAINER-PORT>`: ì»¨í…Œì´ë„ˆê°€ ìˆ˜ì‹  ëŒ€ê¸°í•˜ëŠ” í¬íŠ¸ì…ë‹ˆë‹¤. ì´ ë§¤ê°œë³€ìˆ˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.
  
ì˜ˆë¥¼ ë“¤ì–´ ë‹¤ìŒ ëª…ë ¹ì€ nginx ì»¨í…Œì´ë„ˆì˜ í¬íŠ¸ 80ì„ swarmì˜ ëª¨ë“  ë…¸ë“œì— ëŒ€í•´ í¬íŠ¸ 8080ì— ê²Œì‹œí•©ë‹ˆë‹¤.

```bash
docker service create \
  --name my-web \
  --publish published=8080,target=80 \
  --replicas 2 \
  nginx
```

ë¼ìš°íŒ… ë©”ì‹œëŠ” ê²Œì‹œëœ í¬íŠ¸ì— ëŒ€í•´ ë…¸ë“œì— í• ë‹¹ëœ ëª¨ë“  IP ì£¼ì†Œì—ì„œ ìˆ˜ì‹  ëŒ€ê¸°í•˜ê³  ì„ì˜ ë…¸ë“œì˜ 8080ë²ˆ í¬íŠ¸ë¡œ ë“¤ì–´ì˜¨ ìš”ì²­ì„ í™œì„± ì»¨í…Œì´ë„ˆë¡œ ë¼ìš°íŒ…í•©ë‹ˆë‹¤.
  
![image](https://user-images.githubusercontent.com/87158339/212924296-05571c0a-30d6-4b1c-9dad-2d5321664fae.png)

```bash
# 1. ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ê¸°ì¡´ ì„œë¹„ìŠ¤ì— ëŒ€í•œ í¬íŠ¸ë¥¼ ê²Œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
docker service update \
  --publish-add published=<PUBLISHED-PORT>,target=<CONTAINER-PORT> \
  <SERVICE>

# 2. 'docker service inpsect <SERVICE>' ëª…ë ¹ì„ í†µí•´ ì„œë¹„ìŠ¤ì— ê²Œì‹œëœ í¬íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
docker service inspect --format="{{json .Endpoint.Spec.Ports}}" my-web

[{"Protocol":"tcp","TargetPort":80,"PublishedPort":8080}]
```

### TCP ë˜ëŠ” UDP ì „ìš© í¬íŠ¸ ê²Œì‹œ
---
ê¸°ë³¸ì ìœ¼ë¡œ í¬íŠ¸ë¥¼ ê²Œì‹œí•˜ë©´ TCP í¬íŠ¸ì…ë‹ˆë‹¤. `--published` , `-p` í”Œë˜ê·¸ì— `protocol` í‚¤ë¥¼ TCP ë˜ëŠ” UDPë¡œ ì§€ì •í•˜ë©´ TCP/UDP/TCP+UDP í¬íŠ¸ë¥¼ ê²Œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

```bash
# 1.1 ê¸´ êµ¬ë¬¸ TCP
docker service create --name dns-cache \
  --publish published=53,target=53 \
  dns-cache

# 1.2 ì§§ì€ êµ¬ë¬¸ TCP
docker service create --name dns-cache \
  -p 53:53 \
  dns-cache

# 2.1 ê¸´ êµ¬ë¬¸ TCPì™€ UDP
docker service create --name dns-cache \
  --publish published=53,target=53 \
  --publish published=53,target=53,protocol=udp \
  dns-cache

# 2.2 ì§§ì€ êµ¬ë¬¸ TCPì™€ UDP
docker service create --name dns-cache \
  -p 53:53 \
  -p 53:53/udp \
  dns-cache

# 3.1 ê¸´ êµ¬ë¬¸ UDP
docker service create --name dns-cache \
  --publish published=53,target=53,protocol=udp \
  dns-cache

# 3.2 ì§§ì€ êµ¬ë¬¸ UDP
docker service create --name dns-cache \
  -p 53:53/udp \
  dns-cache
```

### ë¼ìš°íŒ… ë©”ì‹œ ìš°íšŒ
---
ë¼ìš°íŒ… ë©”ì‹œë¥¼ ìš°íšŒí•˜ë©´ ì§€ì •ëœ ë…¸ë“œì˜ ë°”ì¸ë”©ëœ í¬íŠ¸ì— ì ‘ì†í•  ë•Œ í•­ìƒ **í•´ë‹¹ ë…¸ë“œ**(ì¼ë°˜ì ìœ¼ë¡œ ë¼ìš°íŒ… ë©”ì‹œë¡œ ë“¤ì–´ì˜¨ ìš”ì²­ì€ ìŠ¤ì›œ í´ëŸ¬ìŠ¤í„°ë¡œ ë“±ë¡ëœ ëª¨ë“  ë…¸ë“œì˜ í™œì„± ì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…ë˜ëŠ” ì ì„ ìƒê¸°í•˜ë¼.)ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ì— ì—‘ì„¸ìŠ¤í•˜ë„ë¡ í•©ë‹ˆë‹¤. ì´ê²ƒì„ `host` ëª¨ë“œë¼ê³  í•©ë‹ˆë‹¤. ëª‡ê°€ì§€ ëª…ì‹¬í•  ì‚¬í•­ìœ¼ë¡œ ë‹¤ìŒì„ ì°¸ê³ í•˜ì„¸ìš”.

- ì„œë¹„ìŠ¤ taskê°€ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ” ë…¸ë“œì— ì—‘ì„¸ìŠ¤í•˜ë©´ ì•„ë¬´ëŸ° taskë„ ìˆ˜ì‹  ëŒ€ê¸° ì¤‘ì´ì§€ ì•Šìœ¼ë¯€ë¡œ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ë‹¤.
- ë™ì¼í•œ ë…¸ë“œì—ì„œ ê°™ì€ taskë¥¼ ì‹¤í–‰í•˜ëŠ”ê²½ìš° Docker host Portë¥¼ ì„ì˜ë¡œ ì§€ì •í•  ìˆ˜ ì—†ë‹¤.
- ì´ëŸ° ê²½ìš° Dockerê°€ ì„ì˜ì˜ ë†’ì€ ë²ˆí˜¸ì˜ í¬íŠ¸ë¥¼ í• ë‹¹í•˜ë„ë¡ `published`í•˜ê±°ë‚˜ ê¸€ë¡œë²Œ ì„œë¹„ìŠ¤ë¡œ ì‚¬ìš©í•˜ê±°ë‚˜ ë°°ì¹˜ ì œì•½ì¡°ê±´ì„ ì‚¬ìš©í•˜ì—¬ ì§€ì •ëœ ë…¸ë“œì—ì„œ ë‹¨ì¼ taskë§Œ ì‹¤í–‰ë˜ë„ë¡ êµ¬ì„±í•´ì•¼í•œë‹¤.

ë¼ìš°íŒ… ë©”ì‹œë¥¼ ìš°íšŒí•˜ë ¤ë©´ ê¸´ êµ¬ë¬¸ì˜ `--publish` í”Œë˜ê·¸ë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ê³  ì´ë–„ `mode`ëŠ” `host`ë¡œ ì„¤ì •í•´ì•¼í•©ë‹ˆë‹¤.(`mode`ë¥¼ ìƒëµí•˜ëŠ” ê²½ìš° `ingress`ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.) ë‹¤ìŒ ëª…ë ¹ì€ ë¼ìš°íŒ… ë©”ì‹œë¥¼ ìš°íšŒí•˜ëŠ” ê¸€ë¡œë²Œ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```bash
docker service create --name dns-cache \
  --publish published=53,target=53,protocol=udp,mode=host \
  --mode global \
  dns-cache
```

### ì™¸ë¶€ ë¡œë“œ ë°¸ëŸ°ì„œ êµ¬ì„±
---
- ë¼ìš°íŒ… ë©”ì‹œì™€ í•¨ê»˜ ì‚¬ìš©
- ë¼ìš°íŒ… ë©”ì‹œ ì—†ì´ ì‚¬ìš©

#### ë¼ìš°íŒ… ë©”ì‹œì™€ í•¨ê»˜ ì‚¬ìš©
Swarm ì„œë¹„ìŠ¤ë¡œ ìš”ì²­ì„ ë¼ìš°íŒ…í•˜ë„ë¡ ì™¸ë¶€ ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ í¬íŠ¸ 8080ì— ê²Œì‹œëœ nginx ì„œë¹„ìŠ¤ì— ëŒ€í•œ ìš”ì²­ì„ ë¶€í•˜ë¶„ì‚°ì„ í•˜ë„ë¡ [HAProxyë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.](https://www.haproxy.org/)

![image](https://user-images.githubusercontent.com/87158339/213177194-7d9b90be-294a-41d5-a7cc-e9c6425c0c44.png)

ì´ ê²½ìš° ë¡œë“œë°¸ëŸ°ì„œì—ì„œ Swarm ë…¸ë“œì˜ 8080 í¬íŠ¸ì— ì—°ê²°í•  ìˆ˜ ìˆì–´ì•¼ í•˜ê³  Swarm ë…¸ë“œëŠ” ë¡œë“œë°¸ëŸ°ì„œì— ì—‘ì„¸ìŠ¤í•  ìˆ˜ ìˆì§€ë§Œ Public í™˜ê²½ì— êµ¬ì„±í•˜ì§€ ì•Šê³  Private í™˜ê²½ì— êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‹¤ìŒì€ HAProxy(L7 ë¡œë“œë°¸ëŸ°ì„œ) 80ë²ˆ í¬íŠ¸ë¡œ ë“¤ì–´ì˜¨ ìš”ì²­ì„ Swarmì˜ ê° ë…¸ë“œ 8080ë²ˆ í¬íŠ¸ì— ì „ë‹¬í•˜ëŠ” HAProxy êµ¬ì„± (`/etc/haproxy/haproxy.cfg`) ì…ë‹ˆë‹¤. 

```bash
global
        log /dev/log    local0
        log /dev/log    local1 notice
...snip...

# Configure HAProxy to listen on port 80
frontend http_front
   bind *:80
   stats uri /haproxy?stats
   default_backend http_back

# Configure HAProxy to route requests to swarm nodes on port 8080
backend http_back
   balance roundrobin
   server node1 192.168.99.100:8080 check
   server node2 192.168.99.101:8080 check
   server node3 192.168.99.102:8080 check
```

ë¡œë“œë°¸ëŸ°ì„œì— ì˜í•´ ë¶„ì‚°ëœ ìš”ì²­ì€ Swarmì˜ ë…¸ë“œë¡œ ë“¤ì–´ì˜¤ê³  ë¼ìš°íŒ… ë©”ì‹œëŠ” ìš”ì²­ì„ í™œì„± taskë¡œ ë¼ìš°íŒ…í•©ë‹ˆë‹¤. 

#### ë¼ìš°íŒ… ë©”ì‹œ ì—†ì´ ì‚¬ìš©
- ë¼ìš°íŒ… ë©”ì‹œ ì—†ì´ ì™¸ë¶€ ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ `--endpoint-mode`ì˜ ê¸°ë³¸ ê°’ì¸ `vip`(Docker ë‚´ë¶€ DNSëŠ” ì„œë¹„ìŠ¤ ì´ë¦„ì„ VIPë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.)ëŒ€ì‹  `dnsrr`ë¡œ ì„¤ì •í•´ì•¼í•©ë‹ˆë‹¤.
- ì´ ê²½ìš° VIPê°€ ì—†ê³  DockerëŠ” ì„œë¹„ìŠ¤ ì´ë¦„ì— ëŒ€í•œ DNS ì¿¼ë¦¬ê°€ taskì˜ IP ì£¼ì†Œ ëª©ë¡ì„ ë°˜í™˜í•˜ë„ë¡ DNS ë ˆì½”ë“œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

#### Docker Engine DNS Server Architecture
![image](https://user-images.githubusercontent.com/87158339/213188751-c4039ff6-43e0-4e7a-8dfc-ba93785ed18a.png)

## ğŸ“Œì¶œì²˜
[Docker Docs](https://docs.docker.com/engine/swarm/swarm-tutorial/drain-node/)

***
    ğŸ‘ ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ì˜¤ë¥˜ë‚˜ ì¡°ì–¸ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ëŒ“ê¸€ í˜¹ì€ ë©”ì¼ë¡œ ë‚¨ê²¨ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤! ğŸ˜„

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}