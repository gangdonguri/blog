---
title: '[Project] Code-States DevOps Bootcamp Project2'
excerpt: "Project2 íšŒê³ "

categories:
  - Project
tags: 
  - [Project]

date: 2023-01-25
last_modified_at: 2023-01-25
---

# Project2
<details>
<summary>Day 1</summary>
<div markdown="1">       

- [x] ë§ˆì¼ìŠ¤í†¤1 - Hello World ì„œë²„ ì»¨í…Œì´ë„ˆí™”
- [x] ë§ˆì¼ìŠ¤í†¤2 - docker-compose ì‘ì„±
- [x] ë§ˆì¼ìŠ¤í†¤3 - ì´ë¯¸ì§€ repository push ìë™í™”

</div>
</details>
<details>
<summary>Day 2</summary>
<div markdown="1">       

- [x] ë§ˆì¼ìŠ¤í†¤4 - ì´ë¯¸ì§€ ECS ë°°í¬
- [x] ë§ˆì¼ìŠ¤í†¤5 - ì„œë²„ ì´ë¯¸ì§€ ECS ë°°í¬ ìë™í™”
- [x] ë§ˆì¼ìŠ¤í†¤6 - ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ HTTPS ì ìš©

</div>
</details>
<details>
<summary>Day 3</summary>
<div markdown="1">       

- [x] ë§ˆì¼ìŠ¤í†¤7 - í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ìë™í™”
- [x] ë§ˆì¼ìŠ¤í†¤8 - í”„ë¡ íŠ¸ì—”ë“œ HTTPS ì ìš©
- [x] ë§ˆì¼ìŠ¤í†¤9 - í”„ë¡ íŠ¸ì—”ë“œ-ì„œë²„ ì—°ê²° í™•ì¸

</div>
</details>
<details>
<summary>Day 4</summary>
<div markdown="1">       

- [ ] ë§ˆì¼ìŠ¤í†¤10 - ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ CRUD êµ¬í˜„

</div>
</details>

## ë§ˆì¼ìŠ¤í†¤1 - Hello World ì„œë²„ ì»¨í…Œì´ë„ˆí™”
<details>
<summary>1. was ì„œë²„ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ</summary>
<div markdown="1">       

```bash
# TODO 1. fastify-cli ì„¤ì¹˜
$ npm i --global fastify-cli

# TODO 2. node v16.19.0 ì„¤ì¹˜
$ nvm install v16.19.0

# TODO 3. default ë…¸ë“œ ë²„ì „ ì„¤ì •
$ nvm alias default v16.19.0

# TODO 4. fastify helloworld-was í”„ë¡œì íŠ¸ ìƒì„±
$ fastify generate helloworld-was

# TODO 5. npm start listen ip ë³€ê²½
$ cd helloworld-was/
$ vim package.json
{
  "name": "helloworld-was",
  "version": "1.0.0",
  "description": "This project was bootstrapped with Fastify-CLI.",   
  "main": "app.js",
  "directories": {
    "test": "test"
  },
  "scripts": {
    "test": "tap \"test/**/*.test.js\"",
    "start": "fastify start -l info app.js --address 0.0.0.0",        
    "dev": "fastify start -w -l info -P app.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "fastify": "^4.0.0",
    "fastify-plugin": "^4.0.0",
    "@fastify/autoload": "^5.0.0",
    "@fastify/sensible": "^5.0.0",
    "fastify-cli": "^5.7.1"
  },
  "devDependencies": {
    "tap": "^16.1.0"
  }
}

# TODO 6. .dockerignore íŒŒì¼ ì¶”ê°€
$ vim .dockerignore
node_modules

# TODO 7. Dockerfile ì¶”ê°€
$ vim Dockerfile
FROM node:16-alpine

WORKDIR /app
COPY ["package.json", "package-lock.json*", "./"]
RUN npm install

ENV NODE_ENV production
EXPOSE 3000

COPY . .
CMD ["npm", "start"]

# TODO 8. docker ì´ë¯¸ì§€ ë¹Œë“œ
$ docker build -t helloworld-was:1.0 .

# TODO 9. ë¹Œë“œí•œ ì´ë¯¸ì§€ AWS ECRì— í‘¸ì‹œ (aws cli ì„¤ì¹˜ ë° credential ë“±ë¡ í•„ìš”)
$ aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 901512289056.dkr.ecr.ap-northeast-2.amazonaws.com
$ docker tag helloworld-was:1.0 901512289056.dkr.ecr.ap-northeast-2.amazonaws.com/helloworld-was:1.0
$ docker push 901512289056.dkr.ecr.ap-northeast-2.amazonaws.com/helloworld-was:1.0
```

</div>
</details>

## ë§ˆì¼ìŠ¤í†¤2 - docker-compose ì‘ì„±
<details>
<summary>1. docker-composeë¥¼ ì´ìš©í•´ wasì™€ mongodb í•œë²ˆì— ë„ìš°ê¸°</summary>
<div markdown="1">       

```bash
# TODO 1. @fastify/mongodb ì˜ì¡´ì„± ì„¤ì¹˜
$ vim package.json
{
  "name": "helloworld-was",
  "version": "1.0.0",
  "description": "This project was bootstrapped with Fastify-CLI.",   
  "main": "app.js",
  "directories": {
    "test": "test"
  },
  "scripts": {
    "test": "tap \"test/**/*.test.js\"",
    "start": "fastify start -l info app.js --address 0.0.0.0",        
    "dev": "fastify start -w -l info -P app.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "fastify": "^4.0.0",
    "fastify-plugin": "^4.0.0",
    "@fastify/autoload": "^5.0.0",
    "@fastify/sensible": "^5.0.0",
    "@fastify/mongodb": "^6.2.0",
    "fastify-cli": "^5.7.1"
  },
  "devDependencies": {
    "tap": "^16.1.0"
  }
}

# TODO 2. .env íŒŒì¼ ì¶”ê°€
MONGO_USERNAME="root"
MONGO_PASSWORD="example"
MONGO_HOSTNAME="mongo"

# TODO 3. mongodb.js íŒŒì¼ ì¶”ê°€
$ vim plugins/mongodb.js
'use strict'

const fp = require('fastify-plugin')

const { MONGO_HOSTNAME, MONGO_USERNAME, MONGO_PASSWORD } = process.env

module.exports = fp(async function (fastify, opts) {
  const url = `mongodb://${MONGO_USERNAME}:${MONGO_PASSWORD}@${MONGO_HOSTNAME}:27017/?authMechanism=DEFAULT`
  console.log(url)

  fastify.register(require('@fastify/mongodb'), {
    forceClose: true,
    url: url
  })

  console.log('í”ŒëŸ¬ê·¸ì¸ ë“±ë¡ì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤.')
})

# TODO 4. was ì´ë¯¸ì§€ ë¹Œë“œ
$ docker build -t helloworld-was:1.1 .

# TODO 5. docker-compose íŒŒì¼ ì¶”ê°€
$ vim docker-compose.yml
version: '3.1'

services:
  was:
    image: helloworld-was:1.1
    restart: always
    ports:
      - 8080:3000
    depends_on:
      - mongo

  mongo:
    image: mongo:4.4
    restart: always
    ports:
      - 27017:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example

# TODO 6. helloworld-wasì™€ mongodb í•œë²ˆì— ì‹¤í–‰
$ docker-compose up -d
```

</div>
</details>


## ë§ˆì¼ìŠ¤í†¤3 - ì´ë¯¸ì§€ repository push ìë™í™”
<details>
<summary>1. github secret ìƒì„±</summary>
<div markdown="1">       
  
**1ï¸âƒ£ github repository ì ‘ì†**

![image](https://user-images.githubusercontent.com/87158339/214455715-fa3101ba-45e9-4c0a-a5a6-9509ee2b764c.png){: width="700" height="500"}
  
**2ï¸âƒ£ Settings í´ë¦­**

![image](https://user-images.githubusercontent.com/87158339/214455848-f6cfbba9-d879-4425-a35b-505302982e08.png){: width="700" height="500"}
  
**3ï¸âƒ£ Secrets and variables -> Actions í´ë¦­**

![image](https://user-images.githubusercontent.com/87158339/214455971-51d420d6-708a-4534-9d24-6f7552874b22.png){: width="700" height="600"}
  
**4ï¸âƒ£ AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY ì´ë¦„ìœ¼ë¡œ Secret ìƒì„±**

![image](https://user-images.githubusercontent.com/87158339/214456182-4ab9578d-ced1-477e-8477-f12284eba9e8.png){: width="700" heigth="600}

</div>
</details>

<details>
<summary>2. workflow ì‘ì„±</summary>
<div markdown="1">       

**1ï¸âƒ£ workflow ì‘ì„±**
  
```yml
name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build_push:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      
    - name: Extrack version name
      id: extrack_version_name
      run: echo "##[set-output name=version;]$(echo '${{ github.event.head_commit.message }}' | egrep -o '[0-9]{1}\.[0-9]{1}')"

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build, tag, and push docker image to Amazon ECR
      env: 
        REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        REPOSITORY: helloworld-was
        IMAGE_TAG: ${{ steps.extrack_version_name.outputs.version }}
      run: |
        docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG .
        docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG
```
  
**2ï¸âƒ£ ì´ë¯¸ì§€ í‘¸ì‹œ**
```bash
$ git add .
$ git commit -m "v1.2"
$ git push myrepo main
```

</div>
</details>

## ë§ˆì¼ìŠ¤í†¤4 - ì´ë¯¸ì§€ ECS ë°°í¬
<details>
<summary>1. ì„œë²„ ì´ë¯¸ì§€ ECS ë°°í¬</summary>
<div markdown="1">       

**1ï¸âƒ£ í´ëŸ¬ìŠ¤í„° ìƒì„±**

![image](https://user-images.githubusercontent.com/87158339/214461572-3d0ae7bf-af6a-4f43-81ad-89da2da34bc1.png){: width="700" heigth="700"}

**2ï¸âƒ£ í…ŒìŠ¤í¬ ì •ì˜**

![image](https://user-images.githubusercontent.com/87158339/214462968-afa74715-c428-4298-984c-cfb5061ad592.png){: width="700" heigth="700}
  
![image](https://user-images.githubusercontent.com/87158339/214462863-14d1a61a-f38a-4c22-8165-672c68f04ad5.png){: width="700" heigth="700"}

**3ï¸âƒ£ ì„œë¹„ìŠ¤ ìƒì„±**
  
![image](https://user-images.githubusercontent.com/87158339/214463343-c308d7ef-7283-45e0-85bc-0768335bc23d.png){:width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214463409-0e820e6b-43c4-449c-82f4-ba597138cfa4.png){:width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214463484-46086d94-33dd-4000-8bf0-b58ed9c73e3b.png){:width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214463591-13f6c7d7-8ee7-4c56-a84a-bef53d91d6fa.png){:width="700" heigth="700"}


</div>
</details>

<details>
<summary>2. mongodb ì´ë¯¸ì§€ ECS ë°°í¬</summary>
<div markdown="1">       

**1ï¸âƒ£ í´ëŸ¬ìŠ¤í„° ìƒì„±**
  
![image](https://user-images.githubusercontent.com/87158339/214464292-d18fa68c-4caf-4695-b451-a686e8800e61.png){:width="700" heigth="700"}

**2ï¸âƒ£ mongo ë¦¬í¬ì§€í† ë¦¬ ìƒì„±**
  
![image](https://user-images.githubusercontent.com/87158339/214465625-e65a32a0-1fc3-431f-93ac-51f60a7df96b.png){:width="700" heigth="700"}

**3ï¸âƒ£ mongo ì´ë¯¸ì§€ í‘¸ì‹œ**

```bash
$ aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 901512289056.dkr.ecr.ap-northeast-2.amazonaws.com
$ docker pull docker.io/mongo:4.4
$ docker tag mongo:4.4 901512289056.dkr.ecr.ap-northeast-2.amazonaws.com/helloworld-mongo:4.4
$ docker push 901512289056.dkr.ecr.ap-northeast-2.amazonaws.com/helloworld-mongo:4.4
```

**4ï¸âƒ£ ë³´ì•ˆì•”í˜¸ ì¶”ê°€**
  
![image](https://user-images.githubusercontent.com/87158339/214467163-408a553f-09c7-4d8b-ad4c-6a4c006ab80e.png){:width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214467298-79b23a08-cb2e-4220-8d98-be0009b866fa.png){:width="700" heigth="700"}

**5ï¸âƒ£ í…ŒìŠ¤í¬ ì •ì˜**
  
![image](https://user-images.githubusercontent.com/87158339/214467657-8bfbe1eb-66c9-46ec-be15-c553db62fc19.png){:width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214470529-da97a07b-1325-477d-a146-6b3644f91e7f.png){:width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214467861-1cd056a8-afc6-403d-b1ff-bb8bfcbc88e2.png){:width="700" heigth="700"}

**6ï¸âƒ£ nlb ìƒì„±**
  
![image](https://user-images.githubusercontent.com/87158339/214468541-7ccf9b69-8fac-4218-9ae5-246322b04d94.png){:width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214468648-c76f3ce3-1f8d-42ff-91ff-2d246963e3f9.png){:width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214468783-d3af1184-7316-4dfa-98cd-d7215317a9a2.png){:width="700" heigth="700"}

**7ï¸âƒ£ ì„œë¹„ìŠ¤ ìƒì„±**
  
![image](https://user-images.githubusercontent.com/87158339/214468864-9cd6cd8e-3e75-45ca-92df-fc67370a82ae.png){:width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214468933-80163dcc-1954-477c-a68e-ef6264d03eea.png){:width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214468991-271cda7d-ad7c-40b9-912b-90145a656125.png){:width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214469063-6f4b6b0a-f22e-4bec-9014-14b02bb21895.png){:width="700" heigth="700"}

</div>
</details>

## ë§ˆì¼ìŠ¤í†¤5 - ì„œë²„ ì´ë¯¸ì§€ ECS ë°°í¬ ìë™í™”
<details>
<summary>1. WAS ì†ŒìŠ¤ì½”ë“œ ìˆ˜ì •</summary>
<div markdown="1">       

```bash
$ vim .env
MONGO_USERNAME="root"
MONGO_PASSWORD="example"
MONGO_HOSTNAME="helloworld-mongo-nlb-7f8ae9ef38792a71.elb.ap-northeast-2.amazonaws.com"

$ vim routes/example/index.js
module.exports = async function (fastify, opts) {
  fastify.post('/', async function (request, reply) {
    const test = this.mongo.client.db('test')
    const article = test.collection('article')
    await article.insertOne({ 'title': 'ì•ˆë…• ì„¸ìƒì•„' })

    const result = await article.find({}).toArray();

    reply.send(result)
  })
}

$ vim routes/root.js
'use strict'

module.exports = async function (fastify, opts) {
  fastify.get('/', async function (request, reply) {
    console.log(process.env.MONGO_HOSTNAME)
    console.log(process.env.MONGO_USERNAME)
    return { root: true, host: process.env.MONGO_HOSTNAME, username: process.env.MONGO_USERNAME }
  })
}

$ git add .
$ git commit -m "v1.3"
$ git push myrepo main
```

</div>
</details>

<details>
<summary>2. ìƒˆ ê°œì • ìƒì„±</summary>
<div markdown="1">       

**1ï¸âƒ£ ë³´ì•ˆì•”í˜¸ ìƒì„±**
  
![image](https://user-images.githubusercontent.com/87158339/214471356-7d45f901-d247-4f72-bf8e-c3cecd9d84ae.png){:width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214471465-7340993f-4c00-42a9-a4bf-f816cbebcc0a.png){:width="700" heigth="700"}

**2ï¸âƒ£ ìƒˆ ê°œì • ìƒì„±**
  
![image](https://user-images.githubusercontent.com/87158339/214473942-5f8d98de-e27a-4cae-9094-3689cefab8de.png){:width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214474105-8020d68f-a2e5-4bd7-a5a0-a226e520bb97.png){:width="700" heigth="700"}

**3ï¸âƒ£ ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸**
  
![image](https://user-images.githubusercontent.com/87158339/214474487-e8cbadd5-48b1-4f72-a9be-dcd4c15619a8.png){:width="700" heigth="700"}

</div>
</details>

<details>
<summary>3. ì„œë²„ ë°°í¬ ìë™í™”</summary>
<div markdown="1">       

**1ï¸âƒ£ ì‘ì—… ì •ì˜ JSON íŒŒì¼ì„ Git repositoryì— ì¶”ê°€**
  
```json
$ vim .aws/task-definition.json
{
    "taskDefinitionArn": "arn:aws:ecs:ap-northeast-2:901512289056:task-definition/helloworld-was-td:2",
    "containerDefinitions": [
        {
            "name": "helloworld-was-container",
            "image": "901512289056.dkr.ecr.ap-northeast-2.amazonaws.com/helloworld-was:1.1",
            "cpu": 0,
            "portMappings": [
                {
                    "name": "helloworld-was-container-3000-tcp",
                    "containerPort": 3000,
                    "hostPort": 3000,
                    "protocol": "tcp",
                    "appProtocol": "http"
                }
            ],
            "essential": true,
            "environment": [],
            "environmentFiles": [],
            "mountPoints": [],
            "volumesFrom": [],
            "secrets": [
                {
                    "name": "MONGO_HOSTNAME",
                    "valueFrom": "arn:aws:secretsmanager:ap-northeast-2:901512289056:secret:prod/AppBeta/mongo-VTqmA0:MONGO_HOSTNAME::"
                },
                {
                    "name": "MONGO_USERNAME",
                    "valueFrom": "arn:aws:secretsmanager:ap-northeast-2:901512289056:secret:prod/AppBeta/mongo-VTqmA0:MONGO_USERNAME::"
                },
                {
                    "name": "MONGO_PASSWORD",
                    "valueFrom": "arn:aws:secretsmanager:ap-northeast-2:901512289056:secret:prod/AppBeta/mongo-VTqmA0:MONGO_PASSWORD::"
                }
            ],
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                    "awslogs-create-group": "true",
                    "awslogs-group": "/ecs/helloworld-was-td",
                    "awslogs-region": "ap-northeast-2",
                    "awslogs-stream-prefix": "ecs"
                }
            }
        }
    ],
    "family": "helloworld-was-td",
    "taskRoleArn": "arn:aws:iam::901512289056:role/ecsTaskExecutionRole",
    "executionRoleArn": "arn:aws:iam::901512289056:role/ecsTaskExecutionRole",
    "networkMode": "awsvpc",
    "revision": 2,
    "volumes": [],
    "status": "ACTIVE",
    "requiresAttributes": [
        {
            "name": "com.amazonaws.ecs.capability.logging-driver.awslogs"
        },
        {
            "name": "ecs.capability.execution-role-awslogs"
        },
        {
            "name": "com.amazonaws.ecs.capability.ecr-auth"
        },
        {
            "name": "com.amazonaws.ecs.capability.docker-remote-api.1.19"
        },
        {
            "name": "ecs.capability.secrets.asm.environment-variables"
        },
        {
            "name": "com.amazonaws.ecs.capability.task-iam-role"
        },
        {
            "name": "ecs.capability.execution-role-ecr-pull"
        },
        {
            "name": "com.amazonaws.ecs.capability.docker-remote-api.1.18"
        },
        {
            "name": "ecs.capability.task-eni"
        },
        {
            "name": "com.amazonaws.ecs.capability.docker-remote-api.1.29"
        }
    ],
    "placementConstraints": [],
    "compatibilities": [
        "EC2",
        "FARGATE"
    ],
    "requiresCompatibilities": [
        "FARGATE"
    ],
    "cpu": "1024",
    "memory": "3072",
    "runtimePlatform": {
        "cpuArchitecture": "X86_64",
        "operatingSystemFamily": "LINUX"
    },
    "registeredAt": "2023-01-25T03:32:36.441Z",
    "registeredBy": "arn:aws:iam::901512289056:user/Administrator",
    "tags": [
        {
            "key": "ecs:taskDefinition:createdFrom",
            "value": "ecs-console-v2"
        }
    ]
}
```

**2ï¸âƒ£ workflow ì¶”ê°€**
  
```yml
$ vim .github/workflows/aws.yml
# This workflow will build and push a new container image to Amazon ECR,
# and then will deploy a new task definition to Amazon ECS, when there is a push to the "main" branch.
#
# To use this workflow, you will need to complete the following set-up steps:
#
# 1. Create an ECR repository to store your images.
#    For example: `aws ecr create-repository --repository-name my-ecr-repo --region us-east-2`.
#    Replace the value of the `ECR_REPOSITORY` environment variable in the workflow below with your repository's name.
#    Replace the value of the `AWS_REGION` environment variable in the workflow below with your repository's region.
#
# 2. Create an ECS task definition, an ECS cluster, and an ECS service.
#    For example, follow the Getting Started guide on the ECS console:
#      https://us-east-2.console.aws.amazon.com/ecs/home?region=us-east-2#/firstRun
#    Replace the value of the `ECS_SERVICE` environment variable in the workflow below with the name you set for the Amazon ECS service.
#    Replace the value of the `ECS_CLUSTER` environment variable in the workflow below with the name you set for the cluster.
#
# 3. Store your ECS task definition as a JSON file in your repository.
#    The format should follow the output of `aws ecs register-task-definition --generate-cli-skeleton`.
#    Replace the value of the `ECS_TASK_DEFINITION` environment variable in the workflow below with the path to the JSON file.
#    Replace the value of the `CONTAINER_NAME` environment variable in the workflow below with the name of the container
#    in the `containerDefinitions` section of the task definition.
#
# 4. Store an IAM user access key in GitHub Actions secrets named `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`.
#    See the documentation for each action used below for the recommended IAM policies for this IAM user,
#    and best practices on handling the access key credentials.

name: Deploy to Amazon ECS

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  AWS_REGION: ap-northeast-2                   # set this to your preferred AWS region, e.g. us-west-1
  ECR_REPOSITORY: helloworld-was           # set this to your Amazon ECR repository name
  ECS_SERVICE: helloworld-was-svc                 # set this to your Amazon ECS service name
  ECS_CLUSTER: helloworld-was-cluster                 # set this to your Amazon ECS cluster name
  ECS_TASK_DEFINITION: .aws/task-definition.json # set this to the path to your Amazon ECS task definition
                                               # file, e.g. .aws/task-definition.json
  CONTAINER_NAME: helloworld-was-container         # set this to the name of the container in the
                                               # containerDefinitions section of your task definition

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Extrack version name
      id: extrack_version_name
      run: echo "##[set-output name=version;]$(echo '${{ github.event.head_commit.message }}' | egrep -o '[0-9]{1}\.[0-9]{1}')"

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ steps.extrack_version_name.outputs.version }}
      run: |
        # Build a docker container and
        # push it to ECR so that it can
        # be deployed to ECS.
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Fill in the new image ID in the Amazon ECS task definition
      id: task-def
      uses: aws-actions/amazon-ecs-render-task-definition@v1
      with:
        task-definition: ${{ env.ECS_TASK_DEFINITION }}
        container-name: ${{ env.CONTAINER_NAME }}
        image: ${{ steps.build-image.outputs.image }}

    - name: Deploy Amazon ECS task definition
      uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      with:
        task-definition: ${{ steps.task-def.outputs.task-definition }}
        service: ${{ env.ECS_SERVICE }}
        cluster: ${{ env.ECS_CLUSTER }}
        wait-for-service-stability: true
```

</div>
</details>

## ë§ˆì¼ìŠ¤í†¤6 - ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ HTTPS ì ìš©
<details>
<summary>1. ì¸ì¦ì„œ ë°œê¸‰</summary>
<div markdown="1">       

**1ï¸âƒ£ ì¸ì¦ì„œ ë°œê¸‰ ë° CNAME ìƒì„±**
  
![image](https://user-images.githubusercontent.com/87158339/214475445-927223db-6add-4e76-8101-b53021347a29.png){: width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214475502-9a333338-a2ae-47a2-9bd0-eacaf4f73d9d.png){:width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214475654-bb4c68cb-ae8e-49d8-b644-74211d26b2fe.png){: width="700" heigth="700"}

**2ï¸âƒ£ albì— ëŒ€í•œ ë„ë©”ì¸ ë ˆì½”ë“œ ì¶”ê°€**
  
![image](https://user-images.githubusercontent.com/87158339/214475800-c364532c-2f93-48cb-a048-884606bc57d5.png){: width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214476439-128b5f86-6660-41d8-b6e4-8dc55a883d78.png){: width="700" heigth="700"}

**3ï¸âƒ£ alb ë¦¬ìŠ¤ë„ˆ ì¶”ê°€**
  
![image](https://user-images.githubusercontent.com/87158339/214476607-35ce3307-385a-4b1f-8618-ffbd26362972.png){: width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214476677-88cc419c-3857-4c3b-8598-519fe69dbaf1.png){: width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214476725-45103e7f-0761-4dca-a1c8-946550072ed0.png){: width="700" heigth="700"}

![image](https://user-images.githubusercontent.com/87158339/214476776-3b44c53f-0291-417b-99a1-46e9fa5ad999.png){: width="700" heigth="700"}

</div>
</details>

## ë§ˆì¼ìŠ¤í†¤7 - í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ìë™í™”
<details>
<summary>1. repository fork && clone</summary>
<div markdown="1">       

```bash
$ git clone git@github.com:gangdonguri/project2-frontend.git
$ cd project2-frontend
```

</div>
</details>

<details>
<summary>2. package.json íŒŒì¼ ìˆ˜ì •</summary>
<div markdown="1">       

```bash
$ vim package.json
 16   "scripts": {
 17     "start": "PORT=4000 REACT_APP_ENDPOINT=https://api.devops03-gg.click react-scripts start",
 18     "build": "REACT_APP_ENDPOINT=https://api.devops03-gg.click react-scripts build",

# REACE_APP_ENDPOINT = alb ë¡œë“œë°¸ëŸ°ì„œ ì£¼ì†Œ
```

</div>
</details>

<details>
<summary>3. buildspec.yml íŒŒì¼ ìƒì„±</summary>
<div markdown="1">       

```yml
version: 0.2

phases:
  pre_build:
    commands:
      - npm install
  build:
    commands:
      - npm run build

artifacts:
  files:
    - '**/*'
  base-directory: build

$ git add .
$ git commit -m "[MODIFIED] buildspec.yml ì¶”ê°€ && package.json ìˆ˜ì •"
$ git remote rename origin myrepo
$ git push myrepo master
```

</div>
</details>

<details>
<summary>4. codepipeline ìƒì„±</summary>
<div markdown="1">       

**1ï¸âƒ£ íŒŒì´í”„ë¼ì¸ ì„¤ì •**
  
![image](https://user-images.githubusercontent.com/87158339/214477773-84bbc799-00bc-49ff-bf2f-523cf1405a8f.png){: width="700" heigth="700"}

**2ï¸âƒ£ ì†ŒìŠ¤ ì¶”ê°€**
  
![image](https://user-images.githubusercontent.com/87158339/214477999-5c817ee1-a7b6-4655-bab1-62f5ac005989.png){: width="700" heigth="700"}

**3ï¸âƒ£ ë¹Œë“œ ìŠ¤í…Œì´ì§€ ì¶”ê°€**
  
![image](https://user-images.githubusercontent.com/87158339/214478408-3bab079a-8093-4465-944d-4e84dde3a8f4.png){: width="700" heigth="700"}

**4ï¸âƒ£ ë°°í¬ ìŠ¤í…Œì´ì§€ ì¶”ê°€**
  
![image](https://user-images.githubusercontent.com/87158339/214478553-224a578b-d971-4961-8e1b-0b0027e12bcc.png){: width="700" heigth="700"}

</div>
</details>

## ë§ˆì¼ìŠ¤í†¤8 - í”„ë¡ íŠ¸ì—”ë“œ HTTPS ì ìš©
<details>
<summary>1. ì¸ì¦ì„œ ë°œê¸‰ (us-east-1)</summary>
<div markdown="1">       
  
![image](https://user-images.githubusercontent.com/87158339/214479670-2beae8a6-d905-4417-973f-b2488f5fc1ec.png){: width="700"}

![image](https://user-images.githubusercontent.com/87158339/214479768-8f17d2de-3ed2-4ca7-a52a-0e06e49f0c62.png){: width="700"}

</div>
</details>

<details>
<summary>2. CloudFront ìƒì„±</summary>
<div markdown="1">       

**1ï¸âƒ£ ë°°í¬ ìƒì„±**
  
![image](https://user-images.githubusercontent.com/87158339/214479925-81efe4e9-5ecd-4e9d-8475-8377331b8174.png){: width="700"}

![image](https://user-images.githubusercontent.com/87158339/214480094-11cf5bbd-e7d2-4f9b-8897-92f099b09ff0.png){: width="700"}

![image](https://user-images.githubusercontent.com/87158339/214481165-ea02e35c-3d77-439a-9174-7d97c766e3d5.png){: width="700"}

![image](https://user-images.githubusercontent.com/87158339/214481226-26d658e3-891b-44c9-97fa-b7005c416fb2.png){: width="700"}

**2ï¸âƒ£ ì‚¬ìš©ì ì •ì˜ ì˜¤ë¥˜í˜ì´ì§€ ìƒì„±**
  
![image](https://user-images.githubusercontent.com/87158339/214481440-d69e0902-5265-4b00-b1a5-8d7bb249aaaf.png){: width="700"}

![image](https://user-images.githubusercontent.com/87158339/214481488-35cc20c5-b827-4f99-9da2-cc9a056fc50f.png){: width="700"}

</div>
</details>

<details>
<summary>3. route53 ë ˆì½”ë“œ ìƒì„±</summary>
<div markdown="1">       

![image](https://user-images.githubusercontent.com/87158339/214479831-da488d23-b09b-40bd-8172-ec3996b8e672.png){: width="700"}

![image](https://user-images.githubusercontent.com/87158339/214480307-b8b85a27-f4a9-4017-943b-83a043292619.png){: width="700"}

![image](https://user-images.githubusercontent.com/87158339/214481545-7899ef3b-210b-4ba2-9708-e51fed4e1929.png){: width="700"}

</div>
</details>

## ë§ˆì¼ìŠ¤í†¤9 - í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ ì—°ê²° í™•ì¸
<details>
<summary>1. API ì‘ì„±</summary>
<div markdown="1">       

```bash
# -------------- WAS ì„œë²„ì—ì„œ ì§„í–‰ ---------------
$ mkdir -p routes/api/restaurants/
$ vim routes/api/restaurants/index.js
'use strict'

module.exports = async function (fastify, opts) {
  fastify.get('/', async function (req, reply) {
    reply.send([
      {
        "name": "ìš©ë‹¤ë°©",
        "menu": [
          {
            "name": "ì• í”Œ ì‹œë‚˜ëª¬ ì—ì´ë“œ",
            "price": 6500,
            "duration": 5
          },
          {
            "name": "ì¹´í˜ëª¨ì¹´",
            "price": 6000,
            "duration": 5
          }
        ],
        "address": "ì„œìš¸ì‹œ ë§ˆí¬êµ¬ ì–‘í™”ë¡œ 1111",
        "rating": 4.5
      }
    ])
  })
}
```

</div>
</details>

<details>
<summary>2. cors ì„¤ì •</summary>
<div markdown="1">       

```bash
$ vim plugins/cors.js
'use strict'

const fp = require('fastify-plugin')

module.exports = fp(async function (fastify, opts) {
  fastify.register(require('@fastify/cors'))
})
$ vim package.json
{
  "name": "helloworld-was",
  "version": "1.0.0",
  "description": "This project was bootstrapped with Fastify-CLI.",
  "main": "app.js",
  "directories": {
    "test": "test"
  },
  "scripts": {
    "test": "tap \"test/**/*.test.js\"",
    "start": "fastify start -l info app.js --address 0.0.0.0",
    "dev": "fastify start -w -l info -P app.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "fastify": "^4.0.0",
    "fastify-plugin": "^4.0.0",
    "@fastify/autoload": "^5.0.0",
    "@fastify/sensible": "^5.0.0",
    "@fastify/mongodb": "^6.2.0",
    "@fastify/cors": "^8.2.0",
    "fastify-cli": "^5.7.1"
  },
  "devDependencies": {
    "tap": "^16.1.0"
  }
}

$ git add .
$ git commit -m "[TEST] cors ì„¤ì • v1.3"
$ git push myrepo main
```

</div>
</details>

## ë§ˆì¼ìŠ¤í†¤10 - ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ CRUD êµ¬í˜„
<details>
<summary>1. ë¡œì»¬ í…ŒìŠ¤íŠ¸ë¡œ ì „í™˜</summary>
<div markdown="1">     

```bash
# TODO 1. frontend í”„ë¡œì íŠ¸ì˜ package.json íŒŒì¼ì—ì„œ REACE_APP_ENDPOINTë¥¼ localhostë¡œ ë³€ê²½ í›„ frontend docker image ë¹Œë“œ
$ cd project2-frontend
$ docker build -t frontend:1.1 .
$ docker images
REPOSITORY     TAG     IMAGE ID       CREATED          SIZE
frontend       1.1     a0cb22a5c071   5 minutes ago    367MB

# TODO 2. was í”„ë¡œì íŠ¸ì˜ .env íŒŒì¼ì—ì„œ MONGO_HOSTNAMEì„ mongoë¡œ ë³€ê²½
$ cd helloworld
$ vim .env
MONGO_USERNAME="root"
MONGO_PASSWORD="example"
MONGO_HOSTNAME="mongo"

# TODO 3. docker-compose.yml íŒŒì¼ ìˆ˜ì •
$ vim docker-compose.yml
version: '3.1'

services:
  frontend:
    image: frontend:1.1
    restart: always
    ports:
      - 4000:4000

  api:
    image: helloworld-was:1.1
    restart: always
    ports:
      - 3000:3000
    volumes:
      - ./:/app
    depends_on:
      - mongo

  mongo:
    image: mongo:4.4
    restart: always
    ports:
      - 27017:27017
    volumes:
      - /data/db:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example

# mongo ì„œë¹„ìŠ¤ì—ì„œëŠ” ë°ì´í„° ì˜ì†ì„±ì„ ìœ„í•´ ë°”ì¸ë“œ ë§ˆìš´íŠ¸ ìœ í˜•ì˜ ë³¼ë¥¨ì„ ì—°ê²°
# api ì„œë¹„ìŠ¤ì—ì„œëŠ” ì†ŒìŠ¤ ìˆ˜ì • í›„ ì»¨í…Œì´ë„ˆì— ì¦‰ê° ë°˜ì˜ì„ ìœ„í•´ ë°”ì¸ë“œ ë§ˆìš´íŠ¸ ìœ í˜•ì˜ ë³¼ë¥¨ì„ ì—°ê²°
```

</div>
</details>

<details>
<summary>2. mongoshë¥¼ ì´ìš©í•´ collectionì„ ìƒì„±í•˜ê³  ë°ì´í„° import</summary>
<div markdown="1">       

```js
/*
 ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë¨¼ì € ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
 mongoshì—ì„œ ë‹¤ìŒì„ ì…ë ¥í•˜ì„¸ìš”.
*/

/* use baedal */

db.createCollection('customer')
const customers = db.customer.insertMany([
  {"username":"ê¹€ê°œë°œ","address":"ë¶€ì‚°ê´‘ì—­ì‹œ ìˆ˜ì˜êµ¬ ë¯¼ë½ë¡œ 100ë²ˆê¸¸"},
  {"username":"ìµœìš´ì˜","address":"ì„œìš¸ì‹œ ë§ˆí¬êµ¬ ì–‘í™”ë¡œ 777"}
])

db.createCollection('restaurants')
const menu1 = ObjectId()
const menu2 = ObjectId()
const restaurants = db.restaurants.insertMany([
  {
    "name": "ìš©ë‹¤ë°©",
    "menu": [
      {
        "_id": ObjectId(),
        "name": "ì• í”Œ ì‹œë‚˜ëª¬ ì—ì´ë“œ",
        "price": 6500,
        "duration": 5
      },
      {
        "_id": ObjectId(),
        "name": "ì¹´í˜ëª¨ì¹´",
        "price": 6000,
        "duration": 5
      }
    ],
    "address": "ì„œìš¸ì‹œ ë§ˆí¬êµ¬ ì–‘í™”ë¡œ 1111",
    "rating": 4.5
  },
  {
    "name": "í”¼í”„",
    "menu": [
      {
        "_id": ObjectId(),
        "name": "ì—ìŠ¤í”„ë ˆì†Œ",
        "price": 2000,
        "duration": 5
      },
      {
        "_id": ObjectId(),
        "name": "ìŠ¤íŠ¸ë¼íŒŒì°¨í† ",
        "price": 2500,
        "duration": 5
      },
      {
        "_id": ObjectId(),
        "name": "í¬ë¡œí”Œ",
        "price": 3000,
        "duration": 10
      }
    ],
    "address": "ì„œìš¸ì‹œ ë§ˆí¬êµ¬ ì„±ë¯¸ì‚°ë¡œ 4444",
    "rating": 5
  },
  {
    "name": "ë™ë°±ì»¤í”¼",
    "menu": [
      {
        "_id": menu1,
        "name": "ë™ë°±ì»¤í”¼",
        "price": 4000,
        "duration": 10
      },
      {
        "_id": menu2,
        "name": "ì•„ì¸ìŠˆí˜ë„ˆ",
        "price": 4500,
        "duration": 10
      }
    ],
    "address": "ë¶€ì‚°ì‹œ ìˆ˜ì˜êµ¬ ì„¼í…€1ë¡œ 777",
    "rating": 4.8
  },
  {
    "name": "ë¯¸í¬ ëŒ€êµ¬íƒ•",
    "menu": [
      {
        "_id": ObjectId(),
        "name": "ëŒ€êµ¬íƒ•",
        "price": 10000,
        "duration": 20
      },
      {
        "_id": ObjectId(),
        "name": "ì•Œë§ì´",
        "price": 6000,
        "duration": 20
      }
    ],
    "address": "ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬ ë¯¸í¬ë¡œ 61",
    "rating": 4.5
  }
])

db.createCollection('courier')
const couriers = db.courier.insertMany([
  {"courier":"ìµœë°°ë‹¬","location":"35.169161,129.132079","available":false},
  {"courier":"ë°•ë°°ì†¡","location":"37.550806,126.903781","available":true}
])

db.createCollection('order')
db.order.insertMany([
  {
    "deliveryInfo": {
      "status":"preparing",
      "assignedCourier":"ë°•ë°°ì†¡",
      "estimatedDeleveryTime":40
    },
    "consumer_id": customers.insertedIds[0],
    "restaurant": {
      "name": "ë™ë°±ì»¤í”¼",
      "address": "ë¶€ì‚°ì‹œ ìˆ˜ì˜êµ¬ ì„¼í…€1ë¡œ 777"
    },
    "orderedMenu":[
      {
        "name": "ë™ë°±ì»¤í”¼",
        "price": 4000,
        "quantity": 3
      },
      {
        "name": "ì•„ì¸ìŠˆí˜ë„ˆ",
        "price": 4500,
        "quantity": 2
      },
    ]
  }
])

db.createCollection('review')
db.review.insertMany([
  {
    "comment":"ì»¤í”¼ê°€ ì•„ì£¼ ì¼í’ˆì´ì˜ˆìš”.","rating":4.5,"reply":"ê³ ê°ë‹˜ ê°ì‚¬í•©ë‹ˆë‹¤. ë” ì¢‹ì€ ì»¤í”¼ë¡œ ë³´ë‹µí•˜ê² ìŠµë‹ˆë‹¤.",
    "consumer_id": customers.insertedIds[0]
  }
])
```

</div>
</details>

<details>
<summary>3. ë§¤ì¥ ëª©ë¡ ì¡°íšŒ ê¸°ëŠ¥ êµ¬í˜„</summary>
<div markdown="1">       

**1ï¸âƒ£ API ëª…ì„¸**
- Request 
  - `Method`: GET
  - `Path`: /api/restaurants
  - `Parameters`: ' '
  - `Body`: ' '
- Responses
  - `Code`: 200 OK
  - `Content-type`: application/json
  - `Example Value`:
  
```json
[
  {
    "_id": "62374c64e5bfa293bf21831b",
    "name": "ë™ë°±ì»¤í”¼ ì„¼í…€ì ",
    "menu": [
      {
        "_id": "62374fe0e5bfa293bf218347",
        "name": "ë™ë°±ì»¤í”¼",
        "price": 4000,
        "quantity": 1
      }
    ],
    "address": "ë¶€ì‚°ì‹œ ìˆ˜ì˜êµ¬ ì„¼í…€1ë¡œ 777",
    "rating": 4.8
  }
]
```

**2ï¸âƒ£ ê¸°ëŠ¥ êµ¬í˜„**
```js
$ vim routes/api/restaurants/index.js
'use strict'

module.exports = async function (fastify, opts) {
  fastify.get('/', async function (req, reply) {
    const baedal = this.mongo.client.db('baedal')
    const restaurant = baedal.collection('restaurants')
    const result = await restaurant.find({}).toArray()

    console.log(result)

    reply
      .code(200)
      .header('content-type', 'application/json')
      .send(result)

      }
  )
}
```

</div>
</details>

<details>
<summary>4. ëª¨ë“  ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ ê¸°ëŠ¥ êµ¬í˜„</summary>
<div markdown="1">       

**1ï¸âƒ£ API ëª…ì„¸**
- Request 
  - `Method`: GET
  - `Path`: /api/orders
  - `Parameters`: ' '
  - `Body`: ' '
- Responses
  - `Code`: 200 OK
  - `Content-type`: application/json
  - `Example Value`:
  
```json
[
  {
    "_id": "6237521ae5bfa293bf21836e",
    "restaurant": {
      "_id": "62374c64e5bfa293bf21831b",
      "name": "ë™ë°±ì»¤í”¼ ì„¼í…€ì ",
      "menu": [
        {
          "_id": "62374fe0e5bfa293bf218347",
          "name": "ë™ë°±ì»¤í”¼",
          "price": 4000,
          "quantity": 1
        }
      ],
      "address": "ë¶€ì‚°ì‹œ ìˆ˜ì˜êµ¬ ì„¼í…€1ë¡œ 777",
      "rating": 4.8
    },
    "orderedMenu": [
      {
        "_id": "62374fe0e5bfa293bf218347",
        "name": "ë™ë°±ì»¤í”¼",
        "price": 4000,
        "quantity": 1
      }
    ],
    "deliveryInfo": {
      "status": "PREPARING",
      "assignedCourier": "ê¹€ë°°ë‹¬",
      "estimatedDeleveryTime": 40
    }
  }
]
```

**2ï¸âƒ£ ê¸°ëŠ¥ êµ¬í˜„**
```js
  fastify.get('/', async function (req, reply) {
    console.log('-------------------------------------------------------------------')
    const db = this.mongo.client.db('baedal');
    const collectionOfOrders = db.collection('order');
    const collectionOfrestaurants = db.collection('restaurants');
    const orders = await collectionOfOrders.find({}).toArray();
    const restaurants = await collectionOfrestaurants.find({}).toArray();

    let rating;
    let restaurantId;
    let restaurantMenu = [];
    let currentOrderedMenu = [];
    let result = [];

    for (let order of orders) {
      for (let restaurant of restaurants) {
        if (order.restaurant.name === restaurant.name) {
          restaurantId = restaurant._id;
          rating = restaurant.rating;
          for (let i = 0; i < restaurant.menu.length; i++) {
            restaurantMenu.push(restaurant.menu[i])
          }
        }
      }

      for (let i = 0; i < order.orderedMenu.length; i++) {
        currentOrderedMenu.push(order.orderedMenu[i])
      }
      
      result.push(
        {
          "_id": `${order._id}`,
          "restaurant": {
            "_id": `${restaurantId}`,
            "name": `${order.restaurant.name}`,
            "menu": restaurantMenu,
            "address": `${order.restaurant.address}`,
            "rating": rating,
          },
          "orderedMenu": currentOrderedMenu,
          "deliveryInfo": order.deliveryInfo
        }
      )
      restaurantMenu = [];
      currentOrderedMenu = [];
    }

    reply
      .code(200)
      .header('content-type', 'application/json')
      .send(result)
    
  })
```

</div>
</details>

<details>
<summary>5. ì£¼ë¬¸ ì „ì†¡ ê¸°ëŠ¥ êµ¬í˜„</summary>
<div markdown="1">       

**1ï¸âƒ£ API ëª…ì„¸**
- Request 
  - `Method`: POST
  - `Path`: /api/orders
  - `Parameters`: ' '
  - `Body`: 

```json
{
  "restaurantId": "62374c64e5bfa293bf21831b",
  "menu": [
    {
      "_id": "62374fe0e5bfa293bf218347",
      "name": "ë™ë°±ì»¤í”¼",
      "price": 4000,
      "quantity": 1
    }
  ]
}
```

- Responses
  - `Code`: 201 OK
  - `Content-type`: application/json
  - `Example Value`:

```json
{
  "_id": "6237521ae5bfa293bf21836e",
  "restaurant": {
    "_id": "62374c64e5bfa293bf21831b",
    "name": "ë™ë°±ì»¤í”¼ ì„¼í…€ì ",
    "menu": [
      {
        "_id": "62374fe0e5bfa293bf218347",
        "name": "ë™ë°±ì»¤í”¼",
        "price": 4000,
        "quantity": 1
      }
    ],
    "address": "ë¶€ì‚°ì‹œ ìˆ˜ì˜êµ¬ ì„¼í…€1ë¡œ 777",
    "rating": 4.8
  },
  "orderedMenu": [
    {
      "_id": "62374fe0e5bfa293bf218347",
      "name": "ë™ë°±ì»¤í”¼",
      "price": 4000,
      "quantity": 1
    }
  ],
  "deliveryInfo": {
    "status": "PREPARING",
    "assignedCourier": "ê¹€ë°°ë‹¬",
    "estimatedDeleveryTime": 40
  }
}
```

**2ï¸âƒ£ ê¸°ëŠ¥ êµ¬í˜„**
```js
  fastify.post('/', async function (req, reply) {
    const courier = ['ê¹€ë°°ì†¡', 'ì´ë°°ì†¡', 'ë°•ë°°ì†¡', 'ê¶Œë°°ì†¡', 'ì „ë°°ì†¡']
    const db = this.mongo.client.db('baedal');
    const collectionOfOrders = db.collection('order');
    const collectionOfrestaurants = db.collection('restaurants');
    const restaurantid = this.mongo.ObjectId(req.body.restaurantId);
    const restaurants = await collectionOfrestaurants.find({ "_id": restaurantid }).toArray();

    const newOrderObjectId = this.mongo.ObjectId();
    const newConsumerObjectId = this.mongo.ObjectId();
    const currentOrdercourier = courier[Math.floor(Math.random() * 5)];
    let restaurantMenu = [];
    let orderedMenu = [];
    let insertOrderMenu = [];

    for (let menu of restaurants[0].menu) {
      restaurantMenu.push(menu);
    }

    for (let menu of req.body.menu) {
      orderedMenu.push(menu);
      delete menu._id;
      insertOrderMenu.push(menu)
    }

    await collectionOfOrders.insertOne(
      {
        "_id": newOrderObjectId,
        "deliveryInfo": {
          "status": "preparing",
          "assignedCourier": currentOrdercourier,
          "estimateDeleveryTime": 40
        },
        "consumer_id": newConsumerObjectId,
        "restaurant": {
          "name": restaurants[0].name,
          "address": restaurants[0].address
        },
        "orderedMenu": insertOrderMenu
      }
    )

    const result = {
      "_id": newOrderObjectId,
      "restaurant": {
        "_id": restaurants[0]._id,
        "name": restaurants[0].name,
        "menu": restaurantMenu,
        "address": restaurants[0].address,
        "rating": restaurants[0].rating
      },
      "orderedMenu": orderedMenu,
      "deliveryInfo": {
        "status": "PREPARING",
        "assignedCourier": "ê¹€ë°°ë‹¬",
        "estimateDeleveryTime": 40
      }
    }

    reply
      .code(201)
      .header('content-type', 'application/json')
      .send(result)

  })
```

</div>
</details>

<details>
<summary>6. ê°œë³„ ì£¼ë¬¸ í™•ì¸ ê¸°ëŠ¥ êµ¬í˜„</summary>
<div markdown="1">       

**1ï¸âƒ£ API ëª…ì„¸**
- Request 
  - `Method`: GET
  - `Path`: /api/orders/{id}
  - `Parameters`: {id}
  - `Body`: ' '

- Responses
  - `Code`: 200 OK
  - `Content-type`: application/json
  - `Example Value`:

```json
{
  "_id": "6237521ae5bfa293bf21836e",
  "restaurant": {
    "_id": "62374c64e5bfa293bf21831b",
    "name": "ë™ë°±ì»¤í”¼ ì„¼í…€ì ",
    "menu": [
      {
        "_id": "62374fe0e5bfa293bf218347",
        "name": "ë™ë°±ì»¤í”¼",
        "price": 4000,
        "quantity": 1
      }
    ],
    "address": "ë¶€ì‚°ì‹œ ìˆ˜ì˜êµ¬ ì„¼í…€1ë¡œ 777",
    "rating": 4.8
  },
  "orderedMenu": [
    {
      "_id": "62374fe0e5bfa293bf218347",
      "name": "ë™ë°±ì»¤í”¼",
      "price": 4000,
      "quantity": 1
    }
  ],
  "deliveryInfo": {
    "status": "PREPARING",
    "assignedCourier": "ê¹€ë°°ë‹¬",
    "estimatedDeleveryTime": 40
  }
}
```
**2ï¸âƒ£ ê¸°ëŠ¥ êµ¬í˜„**
```js
  fastify.get('/:id', async function (req, reply) {
    const db = this.mongo.client.db('baedal');
    const collectionOfOrders = db.collection('order');
    const collectionOfrestaurants = db.collection('restaurants');
    const orders = await collectionOfOrders.find({}).toArray();
    const restaurants = await collectionOfrestaurants.find({}).toArray();
    
    let currentOrder;
    let restaurantId;
    let restaurantMenu = [];
    let rating;
    let currentOrderedMenu = [];

    for (let order of orders) {
      if (req.params.id === `${order._id}`) {
        currentOrder = order;
      }
    }

    for (let restaurant of restaurants) {
      if (currentOrder.restaurant.name === restaurant.name) {
        restaurantId = restaurant._id;
        rating = restaurant.rating;
        for (let i = 0; i < restaurant.menu.length; i++) {
          restaurantMenu.push(restaurant.menu[i])
        }
      }
    }

    for (let i = 0; i < currentOrder.orderedMenu.length; i++) {
      currentOrderedMenu.push(currentOrder.orderedMenu[i])
    }

    const result = {
      "_id": `${currentOrder._id}`,
      "restaurant": {
        "_id": `${restaurantId}`,
        "name": `${currentOrder.restaurant.name}`,
        "menu": restaurantMenu,
        "address": `${currentOrder.restaurant.address}`,
        "rating": rating
      },
      "orderedMenu": currentOrderedMenu,
      "deliveryInfo": currentOrder.deliveryInfo
    }

    reply
      .code(200)
      .header('content-type', 'application/json')
      .send(result)

  })
```

</div>
</details>

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…
1. Dockerfile CMD ëª…ë ¹ì˜ ì˜¬ë°”ë¥´ì§€ ëª»í•œ í˜•ì‹
- ë¬¸ì œ: 
  - `CMD ["npm start"] `
  - -> "npm" ëª…ë ¹ê³¼ "start" íŒŒë¼ë¯¸í„° ê°„ì— ì‰¼í‘œë¡œ êµ¬ë¶„ë˜ì§€ ì•ŠìŒ 
  - -> ì»¨í…Œì´ë„ˆì—ì„œ foregroundë¡œ ì‹¤í–‰ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìŒ 
  - -> ì»¨í…Œì´ë„ˆëŠ” ì‹œì‘ê³¼ ë™ì‹œì— exitë¨.
- í•´ê²°: 
  - `CMD ["npm, "start"]`
2. was ì„œë²„ì™€ mongo ì„œë²„ ê°„ì˜ ì—°ê²° ì˜¤ë¥˜
- ë¬¸ì œ: 
  - mongo.js íŒŒì¼ì—ì„œ mongo HOSTNAMEìœ¼ë¡œ localhostë¥¼ ë°”ë¼ë³´ê³  ìˆì—ˆìŒ.
  - was ì„œë²„ë¡œ ìƒì„±ëœ ì»¨í…Œì´ë„ˆì—ì„œ mongoì™€ ì—°ê²°í•˜ê¸° ìœ„í•´ localhost:27017ë¡œ SYNë¥¼ ë³´ëƒ„
  - mongo ì„œë²„ì™€ ì—°ê²° ì‹¤íŒ¨ë¡œ WAS ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
- í•´ê²°: 
  - mongo.js íŒŒì¼ì—ì„œ mongo ì„œë²„ HOSTNAMEì„ docker-copose.yml íŒŒì¼ì— ì •ì˜í•œ ì„œë¹„ìŠ¤ ì´ë¦„ëŒ€ë¡œ 'mongo'ë¡œ ë³€ê²½
3. í…ŒìŠ¤í¬ì—ì„œ secret managerì„ í†µí•´ ìƒì„±í•œ secret ê°’ì„ ê°€ì ¸ì˜¤ëŠ”ë° ìƒê¸°ëŠ” ê¶Œí•œ ë¬¸ì œ
- ë¬¸ì œ:
  - í…ŒìŠ¤í¬ ì •ì˜ ìƒì„± ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” `ecsTaskExecutionRole` Roleì˜ ê²½ìš° secret ê°’ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ê¶Œí•œì´ ë¶€ì—¬ë˜ì§€ ì•ŠìŒ.
- í•´ê²°:
  - `ecsTaskExecutionRole` Roleì— `SecretsManagerReadWrite` ì •ì±…ì„ ì—°ê²°í•¨.
4. cloudfrontì—ì„œ ëŒ€ì²´ ë„ë©”ì¸ì„ ì„¤ì •í•˜ì§€ ì•Šì€ ê²½ìš° ë°œê¸‰í•œ ë„ë©”ì¸ì„ í†µí•œ ì ‘ì†ì´ ë¶ˆê°€ëŠ¥í•¨.
- ë¬¸ì œ:
  - cloudfront ìƒì„± ì‹œ ëŒ€ì²´ ë„ë©”ì¸(CNAME)ì„ ë¶€ì—¬í•˜ì§€ ì•Šì•„ www.devops03-gg.click ë„ë©”ì¸ì„ í†µí•œ ì ‘ì†ì´ ë¶ˆê°€ëŠ¥í•¨.
- í•´ê²°:
  - ìƒì„±ëœ cloudfront ì—ì„œ ì„¤ì •ì„ í¸ì§‘í•˜ì—¬ ëŒ€ì²´ ë„ë©”ì¸ ì¶”ê°€
5. mixed contents ì˜¤ë¥˜
- ë¬¸ì œ:
  - ìœ ì €ê°€ cloudfrontì— ì—°ê²°í•˜ëŠ”ë° https í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ì§€ë§Œ frontì—ì„œ WAS ì„œë²„ì˜ ENDPOINTë¥¼ http í”„ë¡œí† ì½œë¡œ ì§€ì •í•¨.
  - ìœ ì €ì—ì„œ WAS ì„œë²„ë¡œ ë³´ë‚´ëŠ” ì¶”ê°€ ìš”ì²­ì— httpë¥¼ ì‚¬ìš©í•˜ê²Œ ë¨.
  - ë”°ë¼ì„œ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ mixed content ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚´.
- í•´ê²°:
  - frontì—ì„œ WAS ENDPOINT URIë¥¼ ìˆ˜ì •í•¨(http->https)
6. CloudFrontì—ì„œ ì´ì „ ë¬¸ì„œì— ëŒ€í•œ ìºì‹±ìœ¼ë¡œ ì—…ë°ì´íŠ¸ëœ ìµœì‹  ë¬¸ì„œê°€ cloudfrontì— ë°˜ì˜ë˜ì§€ ì•ŠìŒ.
- ë¬¸ì œ:
  - 5ë²ˆ ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  ë¡œì»¬ í…ŒìŠ¤íŠ¸ì—ì„œ ì •ìƒ ì‘ë™ì„ í™•ì¸í•˜ë”ë¼ë„ cloudfrontì—ì„œëŠ” ì´ì „ ë¬¸ì„œê°€ ìºì‹œë˜ì–´ ìˆê¸° ë•Œë¬¸ì— cloudfrontë¡œ ì ‘ì† ì‹œ ë™ì¼í•œ ë¬¸ì œê°€ ë°œìƒí•¨.
- í•´ê²°:
  - CloudFront ì—ì„œ Purge ë™ì‘ì„ í†µí•´ ìºì‹œëœ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•¨.

***
    ğŸ‘ ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ì˜¤ë¥˜ë‚˜ ì¡°ì–¸ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ëŒ“ê¸€ í˜¹ì€ ë©”ì¼ë¡œ ë‚¨ê²¨ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤! ğŸ˜„

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}